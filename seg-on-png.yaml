main:
  params: [event]
  steps:
    # 1) Log the raw event (handy while debugging)
    - log_event:
        call: sys.log
        args:
          text: ${event}
          severity: "INFO"
        next: extract

    # 2) Extract bucket + object name
    - extract:
        assign:
          - bucket: ${event.data.bucket}
          - object: ${event.data.name}
          - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - region: "us-central1"
        next: filter_by_extension

    # 3) Only continue if object is under "scenes/<sceneId>/images/" and ends with .png/.jpg/.jpeg
    - filter_by_extension:
        switch:
          - condition: ${text.match_regex(object, "(?i)^scenes/[^/]+/images/[^/]+\\.(png|jpg|jpeg)$")}
            next: derive_prefixes
        next: skip

    # 4) Derive IMAGES_PREFIX and SEG_PREFIX from object path
    #    object like: "scenes/<sceneId>/images/room.png"
    #    imagesPrefix: "scenes/<sceneId>/images"
    #    segPrefix:    "scenes/<sceneId>/seg"
    - derive_prefixes:
        assign:
          - imagesPrefix: ${text.replace_all(object, "/[^/]+$", "")}
          - sceneId: ${text.split(object, "/")[1]}
          - segPrefix: ${"scenes/" + sceneId + "/seg"}
        next: run_seg_job

    # 5) Run the Cloud Run job sam3-seg-job with env overrides
    - run_seg_job:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: ${"projects/" + projectId + "/locations/" + region + "/jobs/sam3-seg-job"}
          body:
            overrides:
              containerOverrides:
                - env:
                    - name: BUCKET
                      value: ${bucket}
                    - name: IMAGES_PREFIX
                      value: ${imagesPrefix}
                    - name: SEG_PREFIX
                      value: ${segPrefix}
        result: runResult
        next: done

    # 6) Return quick result
    - done:
        return: ${"started sam3-seg-job for " + object}

    # 7) Skip non-image or non-scenes/ objects quietly
    - skip:
        return: ${"skipped object " + object}
