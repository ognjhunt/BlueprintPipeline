# Variation Asset Pipeline Job

End-to-end pipeline for generating SimReady variation assets for domain randomization in Isaac Sim Replicator.

## Overview

This job orchestrates the complete pipeline:

```
replicator-job manifest.json
        ↓
┌───────────────────────────────────────┐
│   variation-asset-pipeline-job        │
│                                       │
│   1. Check asset library (optional)   │
│   2. Generate reference images        │
│      (Gemini 3.0 Pro Image)           │
│   3. Convert to 3D mesh               │
│      (SAM3D or Hunyuan3D)             │
│   4. Add physics properties           │
│      (mass, friction, collision)      │
│   5. Convert to USDZ                  │
└───────────────────────────────────────┘
        ↓
variation_assets/*.usdz (SimReady)
```

## When to Use

Use this job when you need to generate variation assets for a scene that has already been processed by `replicator-job`. The replicator-job creates a manifest of needed assets - this job creates those assets.

**Use Cases:**
- Kitchen scene needs dishes, utensils, food items
- Grocery scene needs packaged goods, produce, bottles
- Laundry scene needs clothing, towels, detergent
- Warehouse scene needs boxes, tools, containers

## Configuration

### Required Environment Variables

| Variable | Description |
|----------|-------------|
| `SCENE_ID` | Scene identifier |
| `GEMINI_API_KEY` | Google AI API key for image generation |

### Optional Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `BUCKET` | - | GCS bucket name |
| `REPLICATOR_PREFIX` | `scenes/{SCENE_ID}/replicator` | Path to replicator bundle |
| `VARIATION_ASSETS_PREFIX` | `scenes/{SCENE_ID}/variation_assets` | Output path |
| `3D_BACKEND` | `auto` | `sam3d`, `hunyuan`, or `auto` |
| `QUALITY_MODE` | `balanced` | `fast`, `balanced`, or `quality` |
| `MAX_ASSETS` | - | Limit number of assets to generate |
| `PRIORITY_FILTER` | - | `required`, `recommended`, or `optional` |
| `ASSET_LIBRARY_PATH` | - | Path to shared asset library |
| `SKIP_EXISTING` | `1` | Skip assets that already exist |
| `DRY_RUN` | `0` | Skip actual generation (for testing) |

### Quality Presets

| Mode | 3D Backend | Image Size | Use Case |
|------|------------|------------|----------|
| `fast` | SAM3D | 512px | Quick iteration, many simple objects |
| `balanced` | Auto | 1024px | Default - good quality/speed balance |
| `quality` | Hunyuan | 2048px | High-quality assets, hero objects |

### 3D Backend Selection

When `3D_BACKEND=auto`, the backend is selected based on asset category:

| SAM3D (Fast) | Hunyuan (Quality) |
|--------------|-------------------|
| dishes | clothing |
| utensils | food |
| cans | produce |
| bottles | tools |
| boxes | electronics |
| containers | lab_equipment |

## Input

The job reads from the replicator bundle:

```
{REPLICATOR_PREFIX}/variation_assets/manifest.json
```

Manifest structure (generated by replicator-job):

```json
{
  "scene_id": "scene_123",
  "scene_type": "kitchen",
  "assets": [
    {
      "name": "plate_ceramic_white",
      "category": "dishes",
      "description": "white ceramic dinner plate",
      "semantic_class": "dish",
      "priority": "required",
      "source_hint": "generate",
      "physics_hints": {
        "mass_range_kg": [0.2, 0.5],
        "friction": 0.4
      },
      "material_hint": "ceramic, porcelain",
      "generation_prompt_hint": "..."
    }
  ]
}
```

## Output

The job produces SimReady assets in the output directory:

```
{VARIATION_ASSETS_PREFIX}/
├── pipeline_summary.json          # Processing summary
├── simready_assets.json           # Asset manifest for downstream
├── .variation_pipeline_complete   # Completion marker
│
├── plate_ceramic_white/
│   ├── reference.png              # Generated reference image
│   ├── model.glb                  # 3D mesh
│   ├── model.usdz                 # USD format (if conversion succeeds)
│   └── metadata.json              # SimReady physics properties
│
├── bowl_cereal_blue/
│   ├── reference.png
│   ├── model.glb
│   ├── model.usdz
│   └── metadata.json
│
└── ...
```

### SimReady Metadata

Each asset includes physics properties:

```json
{
  "asset_name": "plate_ceramic_white",
  "category": "dishes",
  "semantic_class": "dish",
  "simready": true,
  "physics": {
    "mass_kg": 0.35,
    "bulk_density_kg_per_m3": 2400,
    "static_friction": 0.4,
    "dynamic_friction": 0.35,
    "restitution": 0.1,
    "collision_shape": "convex",
    "size_m": [0.25, 0.25, 0.02],
    "volume_m3": 0.00125,
    "center_of_mass_offset": [0, 0, 0],
    "graspable": true,
    "contact_offset_m": 0.005,
    "rest_offset_m": 0.001
  }
}
```

## Integration with Replicator

After this job completes, the Replicator scripts can use the generated assets:

```python
# In Isaac Sim Script Editor
import omni.replicator.core as rep

# Load variation assets
asset_paths = [
    "./variation_assets/plate_ceramic_white/model.usdz",
    "./variation_assets/bowl_cereal_blue/model.usdz",
    # ...
]

# Scatter on placement surfaces
with rep.new_layer():
    objects = rep.create.from_usd(
        rep.distribution.choice(asset_paths),
        semantics=[("class", "dish")],
        count=10
    )

    surfaces = rep.get.prim_at_path("/PlacementRegions/counter_region/Surface")

    with objects:
        rep.randomizer.scatter_2d(
            surface_prims=surfaces,
            check_for_collisions=True
        )
```

## Asset Library (Optional)

For faster processing and asset reuse, you can configure a shared asset library:

```
{ASSET_LIBRARY_PATH}/
├── index.json                    # Searchable index
├── dishes/
│   ├── plate_white_001.usdz
│   ├── plate_white_001.json
│   └── ...
├── groceries/
│   └── ...
└── ...
```

When `ASSET_LIBRARY_PATH` is set, the pipeline will:
1. Check if the asset exists in the library
2. If found, copy it instead of generating
3. If not found, generate and (optionally) add to library

## Performance

| Stage | Duration (per asset) | Notes |
|-------|---------------------|-------|
| Image Generation | 5-15s | Gemini 3.0 Pro Image (Nano Banana Pro) |
| SAM3D Conversion | 30-60s | Good for simple objects |
| Hunyuan Conversion | 2-5min | Higher quality |
| Physics Estimation | <1s | Category-based defaults |
| USDZ Conversion | 1-5s | Requires usd_from_gltf |

**Total per asset:**
- Fast mode: ~1-2 minutes
- Balanced mode: ~2-5 minutes
- Quality mode: ~5-10 minutes

## Troubleshooting

### Common Issues

1. **"Gemini API key not set"**
   - Set `GEMINI_API_KEY` environment variable

2. **"SAM3D inference not available"**
   - SAM3D requires specific checkpoints and dependencies
   - Use `3D_BACKEND=hunyuan` or ensure SAM3D is properly installed

3. **"USDZ conversion failed"**
   - `usd_from_gltf` may not be available
   - GLB files are still usable in Isaac Sim

4. **"No assets to process"**
   - Check that manifest.json exists and has assets with `source_hint="generate"`
   - Check `PRIORITY_FILTER` if set

### Debug Mode

Run with `DRY_RUN=1` to test without actual generation:

```bash
SCENE_ID=test_scene DRY_RUN=1 python run_variation_asset_pipeline.py
```

## Related Jobs

- **replicator-job**: Creates the manifest consumed by this job
- **variation-gen-job**: Legacy image-only generation (replaced by this job)
- **simready-job**: Standalone physics property assignment
- **hunyuan-job**: Standalone Hunyuan 3D generation
- **sam3d-job**: Standalone SAM3D reconstruction
