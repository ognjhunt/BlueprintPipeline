# =============================================================================
# BlueprintPipeline - Genie Sim Server (Isaac Sim) Docker Compose
# =============================================================================
# This compose file provisions Isaac Sim and launches the Genie Sim gRPC server.
#
# Prerequisites:
#   - NVIDIA GPU with 8GB+ VRAM
#   - NVIDIA Container Toolkit installed
#   - NGC authentication for Isaac Sim image pulls
#
# Usage:
#   export GENIESIM_HOST=0.0.0.0
#   export GENIESIM_PORT=50051
#   docker-compose -f docker-compose.geniesim-server.yaml up
# =============================================================================

services:
  geniesim-server:
    build:
      context: .
      dockerfile: Dockerfile.geniesim-server
    image: ${GENIESIM_SERVER_IMAGE:-geniesim-server:latest}
    container_name: geniesim-server
    environment:
      ACCEPT_EULA: "Y"
      PRIVACY_CONSENT: "Y"
      ISAAC_SIM_PATH: ${ISAAC_SIM_PATH:-/isaac-sim}
      GENIESIM_ROOT: ${GENIESIM_ROOT:-/opt/geniesim}
      GENIESIM_HOST: ${GENIESIM_HOST:-0.0.0.0}
      GENIESIM_PORT: ${GENIESIM_PORT:-50051}
      GENIESIM_HEADLESS: ${GENIESIM_HEADLESS:-1}
      GENIESIM_HEALTHCHECK: ${GENIESIM_HEALTHCHECK:-1}
      GENIESIM_SERVER_LOG: ${GENIESIM_SERVER_LOG:-/tmp/geniesim_server.log}
      SIM_ASSETS: /sim-assets
      SIM_ASSETS_ROBOTS: /sim-assets/robots
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      PYTHONPATH: /workspace/BlueprintPipeline/tools/geniesim_adapter:/workspace/BlueprintPipeline
    volumes:
      - ./:/workspace/BlueprintPipeline:rw
      - ${SIM_ASSETS_HOST_PATH:-./sim-assets}:/sim-assets:ro
      - isaac-sim-cache:/root/.cache/ov
      - isaac-sim-data:/root/.local/share/ov
    working_dir: /workspace/BlueprintPipeline
    entrypoint: ["/bin/bash", "-lc"]
    command:
      - ./tools/geniesim_adapter/deployment/start_geniesim_server.sh
    ports:
      - "${GENIESIM_PORT:-50051}:50051"
    shm_size: "16gb"
    privileged: true
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

volumes:
  isaac-sim-cache:
    driver: local
  isaac-sim-data:
    driver: local
