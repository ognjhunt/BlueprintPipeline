# =============================================================================
# BlueprintPipeline - Genie Sim Server (Isaac Sim) Docker Compose
# =============================================================================
# This compose file provisions Isaac Sim and launches the Genie Sim gRPC server.
#
# Prerequisites:
#   - NVIDIA GPU with 8GB+ VRAM
#   - NVIDIA Container Toolkit installed
#   - NGC authentication for Isaac Sim image pulls
#
# Usage:
#   export GENIESIM_HOST=0.0.0.0
#   export GENIESIM_PORT=50051
#   docker-compose -f docker-compose.geniesim-server.yaml up
# =============================================================================

services:
  geniesim-server:
    build:
      context: .
      dockerfile: Dockerfile.geniesim-server
    image: ${GENIESIM_SERVER_IMAGE:-geniesim-server:latest}
    container_name: geniesim-server
    restart: unless-stopped
    environment:
      ACCEPT_EULA: "Y"
      PRIVACY_CONSENT: "Y"
      ISAAC_SIM_PATH: ${ISAAC_SIM_PATH:-/isaac-sim}
      GENIESIM_ROOT: ${GENIESIM_ROOT:-/opt/geniesim}
      GENIESIM_HOST: ${GENIESIM_HOST:-0.0.0.0}
      GENIESIM_PORT: ${GENIESIM_PORT:-50051}
      GENIESIM_HEADLESS: ${GENIESIM_HEADLESS:-1}
      GENIESIM_HEALTHCHECK: ${GENIESIM_HEALTHCHECK:-1}
      GENIESIM_SERVER_LOG: ${GENIESIM_SERVER_LOG:-/tmp/geniesim_server.log}
      GENIESIM_CAMERA_REQUIRE_DISPLAY: ${GENIESIM_CAMERA_REQUIRE_DISPLAY:-1}
      GENIESIM_RUNTIME_READINESS_JSON: ${GENIESIM_RUNTIME_READINESS_JSON:-/workspace/BlueprintPipeline/.geniesim_runtime_readiness.json}
      GENIESIM_RUNTIME_PRESTART_JSON: ${GENIESIM_RUNTIME_PRESTART_JSON:-/workspace/BlueprintPipeline/.geniesim_runtime_prestart_probe.json}
      GENIESIM_KEEP_OBJECTS_KINEMATIC: ${GENIESIM_KEEP_OBJECTS_KINEMATIC:-0}
      GENIESIM_SERVER_CUROBO_MODE: ${GENIESIM_SERVER_CUROBO_MODE:-off}
      # Camera RGB rendering: set ENABLE_CAMERAS=1 + SKIP_RGB_CAPTURE=false
      # to activate. Requires a GPU with working RT cores (T4, L40S, etc.)
      ENABLE_CAMERAS: ${ENABLE_CAMERAS:-0}
      SKIP_RGB_CAPTURE: ${SKIP_RGB_CAPTURE:-true}
      # Renderer mode override for fallback testing
      BP_RENDERER_MODE: ${BP_RENDERER_MODE:-RaytracedLighting}
      BP_RT2_ENABLED: ${BP_RT2_ENABLED:-0}
      BP_DOME_LIGHT_INTENSITY: ${BP_DOME_LIGHT_INTENSITY:-3000.0}
      # DISPLAY must point to an Xorg server with NVIDIA GLX for camera RGB
      # rendering. The host starts Xorg :99 and shares /tmp/.X11-unix.
      DISPLAY: ${DISPLAY:-:99}
      NVIDIA_DRIVER_CAPABILITIES: ${NVIDIA_DRIVER_CAPABILITIES:-all}
      SIM_ASSETS: /sim-assets
      SIM_ASSETS_ROBOTS: /sim-assets/robots
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      PYTHONPATH: /workspace/BlueprintPipeline/tools/geniesim_adapter:/workspace/BlueprintPipeline
    volumes:
      - ./:/workspace/BlueprintPipeline:rw
      - ${SIM_ASSETS_HOST_PATH:-./sim-assets}:/sim-assets:ro
      - isaac-sim-cache:/root/.cache/ov
      - isaac-sim-data:/root/.local/share/ov
      # X11 socket for headless GPU rendering (host runs Xorg :99)
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    working_dir: /workspace/BlueprintPipeline
    entrypoint: ["/bin/bash", "-lc"]
    command:
      - ./tools/geniesim_adapter/deployment/start_geniesim_server.sh
    ports:
      - "${GENIESIM_PORT:-50051}:50051"
    shm_size: "16gb"
    privileged: true
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/isaac-sim/python.sh /workspace/BlueprintPipeline/tools/geniesim_adapter/deployment/readiness_probe.py --check-patches --geniesim-root ${GENIESIM_ROOT:-/opt/geniesim} --output ${GENIESIM_RUNTIME_READINESS_JSON:-/workspace/BlueprintPipeline/.geniesim_runtime_readiness.json}",
        ]
      interval: 10s
      timeout: 10s
      retries: 18
      start_period: 30s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

volumes:
  isaac-sim-cache:
    driver: local
  isaac-sim-data:
    driver: local
