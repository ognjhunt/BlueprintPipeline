# =============================================================================
# Kubernetes Job: Dream2Flow Preparation with Isaac Sim
# =============================================================================
# Deploy on GKE with GPU nodes for Dream2Flow bundle generation.
#
# Dream2Flow: 3D Object Flow Extraction for Embodiment-Agnostic Robot Control
# Paper: arXiv:2512.24766
#
# Prerequisites:
#   1. GKE cluster with GPU node pool (T4 or better)
#   2. NVIDIA GPU device plugin installed
#   3. Secret with GCS service account credentials
#
# Apply:
#   kubectl apply -f dream2flow-preparation-job.yaml
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: dream2flow-config
  namespace: blueprint
data:
  # Dream2Flow configuration
  NUM_TASKS: "5"
  RESOLUTION_WIDTH: "720"
  RESOLUTION_HEIGHT: "480"
  NUM_FRAMES: "49"
  FPS: "24"
  ROBOT: "franka_panda"

  # Force Isaac Sim rendering (no mock)
  RENDER_BACKEND: "isaac_sim"

  # Headless mode
  HEADLESS: "1"

---
apiVersion: v1
kind: Secret
metadata:
  name: dream2flow-secrets
  namespace: blueprint
type: Opaque
stringData:
  GEMINI_API_KEY: ""
  VIDEO_API_ENDPOINT: ""

---
apiVersion: batch/v1
kind: Job
metadata:
  name: dream2flow-preparation
  namespace: blueprint
  labels:
    app: blueprint-pipeline
    component: dream2flow-preparation
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 3600
  activeDeadlineSeconds: 14400  # 4 hours

  template:
    metadata:
      labels:
        app: blueprint-pipeline
        component: dream2flow-preparation
      annotations:
        cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
    spec:
      restartPolicy: OnFailure

      # Schedule on GPU nodes
      nodeSelector:
        cloud.google.com/gke-accelerator: nvidia-tesla-t4

      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule

      serviceAccountName: blueprint-pipeline-sa

      # Validate GPU availability
      initContainers:
        - name: gpu-check
          image: nvidia/cuda:12.1.0-base-ubuntu22.04
          command:
            - sh
            - -c
            - |
              echo "Checking GPU availability for Dream2Flow..."
              nvidia-smi
              if [ $? -ne 0 ]; then
                echo "GPU not available!"
                exit 1
              fi
              echo "GPU check passed"
          resources:
            limits:
              nvidia.com/gpu: 1

      containers:
        - name: dream2flow-generator
          image: ghcr.io/${PROJECT_ID}/blueprint-dream2flow:isaacsim
          imagePullPolicy: Always

          command: ["/entrypoint.sh", "generate"]

          envFrom:
            - configMapRef:
                name: dream2flow-config
            - secretRef:
                name: dream2flow-secrets

          env:
            - name: SCENE_ID
              value: "${SCENE_ID}"
            - name: BUCKET
              value: "${BUCKET}"
            - name: ASSETS_PREFIX
              value: "scenes/${SCENE_ID}/assets"
            - name: USD_PREFIX
              value: "scenes/${SCENE_ID}/usd"
            - name: DREAM2FLOW_PREFIX
              value: "scenes/${SCENE_ID}/dream2flow"
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /secrets/gcs/key.json

          resources:
            requests:
              cpu: "4"
              memory: "16Gi"
              nvidia.com/gpu: 1
            limits:
              cpu: "8"
              memory: "32Gi"
              nvidia.com/gpu: 1

          volumeMounts:
            - name: gcs-credentials
              mountPath: /secrets/gcs
              readOnly: true
            - name: dshm
              mountPath: /dev/shm
            - name: isaac-cache
              mountPath: /root/.cache/ov
            - name: output
              mountPath: /output
            # Model cache for vision models
            - name: model-cache
              mountPath: /models

      volumes:
        - name: gcs-credentials
          secret:
            secretName: gcs-service-account
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 16Gi
        - name: isaac-cache
          emptyDir:
            sizeLimit: 50Gi
        - name: output
          emptyDir:
            sizeLimit: 50Gi
        - name: model-cache
          emptyDir:
            sizeLimit: 20Gi
