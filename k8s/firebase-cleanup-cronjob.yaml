# =============================================================================
# Kubernetes CronJob: Firebase Storage Cleanup
# =============================================================================
# Runs periodic cleanup of orphaned Firebase Storage blobs.
#
# Apply:
#   envsubst < k8s/firebase-cleanup-cronjob.yaml | kubectl apply -f -
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: firebase-cleanup-config
  namespace: blueprint
data:
  FIREBASE_CLEANUP_PREFIX: "datasets"
  FIREBASE_CLEANUP_MAX_AGE_HOURS: "168"
  FIREBASE_CLEANUP_MANIFEST_PATH: ""

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: firebase-cleanup
  namespace: blueprint
  labels:
    app: blueprint-pipeline
    component: firebase-cleanup
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 3600
      template:
        metadata:
          labels:
            app: blueprint-pipeline
            component: firebase-cleanup
        spec:
          restartPolicy: OnFailure
          serviceAccountName: blueprint-pipeline-sa
          containers:
            - name: firebase-cleanup
              image: ghcr.io/${PROJECT_ID}/blueprint-firebase-cleanup:latest
              imagePullPolicy: Always
              envFrom:
                - configMapRef:
                    name: firebase-cleanup-config
                - configMapRef:
                    name: cost-tracking-pricing
              env:
                - name: FIREBASE_STORAGE_BUCKET
                  valueFrom:
                    configMapKeyRef:
                      name: firebase-cleanup-overrides
                      key: FIREBASE_STORAGE_BUCKET
                      optional: true
                - name: FIREBASE_SERVICE_ACCOUNT_JSON
                  valueFrom:
                    configMapKeyRef:
                      name: firebase-cleanup-overrides
                      key: FIREBASE_SERVICE_ACCOUNT_JSON
                      optional: true
                - name: FIREBASE_SERVICE_ACCOUNT_PATH
                  valueFrom:
                    configMapKeyRef:
                      name: firebase-cleanup-overrides
                      key: FIREBASE_SERVICE_ACCOUNT_PATH
                      optional: true
                - name: PYTHONUNBUFFERED
                  value: "1"
              volumeMounts:
                - name: cost-tracking-pricing
                  mountPath: /etc/blueprint/pricing
                  readOnly: true
          volumes:
            - name: cost-tracking-pricing
              configMap:
                name: cost-tracking-pricing-files
