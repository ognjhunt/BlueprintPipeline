name: Build Docker Images

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build:
    name: Build ${{ matrix.image }}
    runs-on: ubuntu-latest
    env:
      REGISTRY: ghcr.io
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: genie-sim-gpu-job
            context: genie-sim-gpu-job
            dockerfile: genie-sim-gpu-job/Dockerfile
          - image: genie-sim-import-job
            context: genie-sim-import-job
            dockerfile: genie-sim-import-job/Dockerfile
          - image: genie-sim-export-job
            context: genie-sim-export-job
            dockerfile: genie-sim-export-job/Dockerfile
          - image: genie-sim-submit-job
            context: genie-sim-submit-job
            dockerfile: genie-sim-submit-job/Dockerfile
          - image: genie-sim-local-job
            context: genie-sim-local-job
            dockerfile: genie-sim-local-job/Dockerfile
          - image: genie-sim-import-webhook
            context: genie-sim-import-webhook
            dockerfile: genie-sim-import-webhook/Dockerfile
          - image: episode-generation-job
            context: episode-generation-job
            dockerfile: episode-generation-job/Dockerfile
          - image: scene-generation-job
            context: scene-generation-job
            dockerfile: scene-generation-job/Dockerfile
          - image: objects-job
            context: objects-job
            dockerfile: objects-job/Dockerfile
          - image: scale-job
            context: scale-job
            dockerfile: scale-job/Dockerfile
          - image: replicator-job
            context: replicator-job
            dockerfile: replicator-job/Dockerfile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Genie Sim ref
        run: |
          GENIESIM_REF="$(cat genie-sim-gpu-job/GENIESIM_REF)"
          if [[ ! "${GENIESIM_REF}" =~ ^[0-9a-f]{40}$ && ! "${GENIESIM_REF}" =~ ^[A-Za-z0-9][A-Za-z0-9._/-]{0,127}$ ]]; then
            echo "GENIESIM_REF must be a full 40-character SHA or a tag-like value."
            echo "Got: ${GENIESIM_REF}"
            exit 1
          fi

      - name: Validate Isaac Sim base image version
        run: |
          ISAAC_SIM_VERSION="$(awk -F= '/^ARG ISAAC_SIM_VERSION=/{print $2}' genie-sim-gpu-job/Dockerfile | xargs)"
          if [[ -z "${ISAAC_SIM_VERSION}" ]]; then
            echo "ISAAC_SIM_VERSION default must be set in genie-sim-gpu-job/Dockerfile."
            exit 1
          fi

      - name: Load Genie Sim ref
        run: echo "GENIESIM_REF=$(cat genie-sim-gpu-job/GENIESIM_REF)" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: ${{ github.ref == 'refs/heads/main' }}
          build-args: |
            GENIESIM_REF=${{ env.GENIESIM_REF }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.image }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.image }}:latest

      - name: Install cosign
        if: github.ref == 'refs/heads/main'
        uses: sigstore/cosign-installer@v3

      - name: Sign and attest image
        if: github.ref == 'refs/heads/main'
        env:
          IMAGE: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.image }}
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          if [[ -z "${DIGEST}" ]]; then
            echo "Missing image digest from build output."
            exit 1
          fi

          cat > cosign-attestation.json <<'EOF'
          {
            "_type": "https://in-toto.io/Statement/v1",
            "predicateType": "https://slsa.dev/provenance/v1",
            "subject": [
              {
                "name": "container-image",
                "digest": {}
              }
            ],
            "predicate": {
              "buildType": "github-actions",
              "builder": {
                "id": "https://github.com/${{ github.repository }}/.github/workflows/docker-build.yml"
              },
              "invocation": {
                "configSource": {
                  "uri": "https://github.com/${{ github.repository }}",
                  "digest": {
                    "sha1": "${{ github.sha }}"
                  }
                }
              }
            }
          }
          EOF

          cosign sign --yes "${IMAGE}@${DIGEST}"
          cosign attest --yes --predicate cosign-attestation.json --type https://slsa.dev/provenance/v1 "${IMAGE}@${DIGEST}"
