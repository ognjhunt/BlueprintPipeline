name: Tests

on:
  push:
    branches: [ main, claude/** ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-xdist
        # Install project dependencies
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

    - name: Lint with flake8
      continue-on-error: true
      run: |
        pip install flake8
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-code is 1 if there are style issues, but don't fail the build
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run unit tests
      run: |
        pytest tests/ \
          -v \
          --cov=tools \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          -n auto

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Generate coverage badge
      continue-on-error: true
      run: |
        pip install coverage-badge
        coverage-badge -o coverage.svg

    - name: Test import of key modules
      run: |
        python -c "from tools.error_handling import PipelineError; print('✓ error_handling imports OK')"
        python -c "from tools.asset_catalog import AssetCatalogBuilder; print('✓ asset_catalog imports OK')"
        python -c "from tools.arena_integration import ArenaExporter; print('✓ arena_integration imports OK')"
        python -c "from tools.isaac_lab_tasks import IsaacLabTaskGenerator; print('✓ isaac_lab_tasks imports OK')"
        python -c "from tools.physics import PhysicsValidator; print('✓ physics imports OK')"
        python -c "from tools.geniesim_adapter import GenieSimImporter; print('✓ geniesim_adapter imports OK')"

  type-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Type check with mypy
      continue-on-error: true
      run: |
        mypy tools/ --ignore-missing-imports --no-error-summary 2>&1 | head -50 || true

  security-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety

    - name: Run bandit security check
      continue-on-error: true
      run: |
        bandit -r tools/ -ll -f json -o bandit-report.json || true

    - name: Check dependencies for vulnerabilities
      continue-on-error: true
      run: |
        safety check --json > safety-report.json || true

  docs:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx-rtd-theme

    - name: Build documentation
      continue-on-error: true
      run: |
        if [ -d docs ]; then cd docs && make html || true; fi
