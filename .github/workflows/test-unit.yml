name: Unit Tests

on:
  push:
    branches:
      - main
      - develop
      - 'claude/**'
    paths:
      - '**.py'
      - 'requirements*.txt'
      - 'pytest.ini'
      - '.coveragerc'
      - 'tests/**'
      - '.github/workflows/test-unit.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.py'
      - 'requirements*.txt'
      - 'pytest.ini'
      - '.coveragerc'
      - 'tests/**'
      - '.github/workflows/test-unit.yml'
  workflow_dispatch:

concurrency:
  group: test-unit-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            libgl1-mesa-glx \
            libglib2.0-0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pytest pytest-cov pytest-timeout pytest-xdist pytest-mock
          pip install -r tools/requirements.txt || true
          pip install -r simready-job/requirements.txt || true
          pip install -r usd-assembly-job/requirements.txt || true
          pip install -r replicator-job/requirements.txt || true

      - name: Run unit tests (fast, non-GPU)
        env:
          PIPELINE_ENV: test
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest tests/ \
            -v \
            -m "unit or (not gpu and not slow and not requires_secrets and not staging)" \
            --tb=short \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --junitxml=junit.xml \
            --durations=10 \
            -n auto

      - name: Enforce coverage threshold
        if: matrix.python-version == '3.10'
        env:
          COVERAGE_THRESHOLD: '75'
        run: |
          python - <<'PY'
          import os
          import sys
          import xml.etree.ElementTree as ET

          threshold = float(os.environ.get("COVERAGE_THRESHOLD", "75"))
          tree = ET.parse("coverage.xml")
          rate = float(tree.getroot().get("line-rate", "0")) * 100
          if rate + 1e-9 < threshold:
              print(
                  "::error::Coverage gate failed: total line coverage "
                  f"{rate:.2f}% is below {threshold:.2f}%. "
                  "Add unit tests or adjust the threshold in "
                  ".github/workflows/test-unit.yml."
              )
              sys.exit(1)
          print(
              "Coverage gate passed: total line coverage "
              f"{rate:.2f}% >= {threshold:.2f}%."
          )
          PY

      - name: Run integration tests (non-GPU, non-GCS)
        env:
          PIPELINE_ENV: test
          PYTHONPATH: ${{ github.workspace }}
          SIMREADY_PHYSICS_MODE: deterministic
          USE_GENIESIM: 'false'
        run: |
          pytest tests/ \
            -v \
            -m "integration and not gpu and not requires_secrets and not requires_gcs and not staging" \
            --tb=short \
            --junitxml=junit-integration.xml \
            --durations=10 \
            -n auto \
            || true

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.10'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-unit-tests
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-python-${{ matrix.python-version }}
          path: |
            junit*.xml
            coverage.xml
            htmlcov/
          if-no-files-found: warn

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            junit*.xml
          check_name: Unit Test Results (Python ${{ matrix.python-version }})
          comment_mode: off

  gpu-tests:
    name: GPU Tests
    runs-on: [self-hosted, linux, gpu]
    timeout-minutes: 60
    needs: unit-tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            libgl1-mesa-glx \
            libglib2.0-0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pytest pytest-cov pytest-timeout pytest-xdist pytest-mock
          pip install -r tools/requirements.txt || true
          pip install -r simready-job/requirements.txt || true
          pip install -r usd-assembly-job/requirements.txt || true
          pip install -r replicator-job/requirements.txt || true

      - name: Run GPU tests
        env:
          PIPELINE_ENV: test
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest tests/ \
            -v \
            -m gpu \
            --tb=short \
            --junitxml=junit-gpu.xml \
            --durations=10

      - name: Upload GPU test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gpu-test-results
          path: junit-gpu.xml
          if-no-files-found: warn

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 mypy pylint

      - name: Check code formatting (black)
        run: |
          black --check --diff . || true

      - name: Check import sorting (isort)
        run: |
          isort --check-only --diff . || true

      - name: Run flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Type checking (mypy) on tools/
        run: |
          mypy tools/ --ignore-missing-imports --no-strict-optional || true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run bandit security scan
        run: |
          bandit -r . -ll -x ./tests,./venv,./.venv

      - name: Check for known vulnerabilities
        run: |
          safety check --json

  status-check:
    name: All Tests Passed
    if: always()
    needs: [unit-tests, gpu-tests, lint, security]
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "Unit tests failed"
            exit 1
          fi
          echo "All tests passed!"
