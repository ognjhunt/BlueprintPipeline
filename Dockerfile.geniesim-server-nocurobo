# =============================================================================
# Pre-baked Genie Sim Server Image (NO cuRobo â€” faster build)
# =============================================================================
# Same as Dockerfile.geniesim-server but skips cuRobo compilation entirely.
# Use when GENIESIM_SERVER_CUROBO_MODE=off (e.g., G1 robot which has no
# cuRobo config). Saves ~30 min of CUDA kernel compilation time.
#
# Build:
#   docker build -f Dockerfile.geniesim-server-nocurobo -t geniesim-server:latest .
# =============================================================================

ARG ISAAC_SIM_VERSION=5.1.0
FROM nvcr.io/nvidia/isaac-sim:${ISAAC_SIM_VERSION}

ENV ISAAC_SIM_PATH=/isaac-sim
ENV GENIESIM_ROOT=/opt/geniesim

USER root

# Build tools needed for native extensions
RUN apt-get update -qq \
    && apt-get install -y -qq --no-install-recommends \
       git build-essential cmake ninja-build \
    && rm -rf /var/lib/apt/lists/*

# ----- Genie Sim repo -----
ARG GENIESIM_REPO=https://github.com/AgibotTech/genie_sim.git
ARG GENIESIM_REF
COPY genie-sim-gpu-job/GENIESIM_REF /tmp/GENIESIM_REF

RUN GENIESIM_REF=${GENIESIM_REF:-$(cat /tmp/GENIESIM_REF)} \
    && git clone --no-checkout ${GENIESIM_REPO} ${GENIESIM_ROOT} \
    && cd ${GENIESIM_ROOT} \
    && git fetch --depth 1 origin ${GENIESIM_REF} \
    && git checkout ${GENIESIM_REF}

# ----- Python dependencies -----
COPY genie-sim-local-job/requirements.txt /tmp/pipeline-requirements.txt

RUN ${ISAAC_SIM_PATH}/python.sh -m pip install --upgrade pip \
    && ${ISAAC_SIM_PATH}/python.sh -m pip install --no-cache-dir \
       -r /tmp/pipeline-requirements.txt \
    && ${ISAAC_SIM_PATH}/python.sh -m pip install --no-cache-dir \
       -r ${GENIESIM_ROOT}/requirements.txt \
    && ${ISAAC_SIM_PATH}/python.sh -m pip install --no-cache-dir \
       "scipy==1.10.1"

# Cache-bust: change this default to force rebuild from this layer onward.
ARG CACHE_BUST_SYMLINK=1

# Fix broken symlinks in Isaac Sim 5.x bundled torch packaging module.
RUN TORCH_PKG="${ISAAC_SIM_PATH}/exts/omni.isaac.ml_archive/pip_prebundle/torch/_vendor/packaging" \
    && REAL_PKG="${ISAAC_SIM_PATH}/kit/python/lib/python3.11/site-packages/packaging" \
    && for f in _structures.py _manylinux.py _musllinux.py; do \
         if [ -L "${TORCH_PKG}/${f}" ] && [ ! -e "${TORCH_PKG}/${f}" ]; then \
           cp "${REAL_PKG}/${f}" "${TORCH_PKG}/${f}" 2>/dev/null || true; \
         fi; \
       done

# ----- cuRobo SKIPPED -----
# cuRobo is not needed when GENIESIM_SERVER_CUROBO_MODE=off (e.g., G1 robot).
# This saves ~30 min of CUDA kernel compilation time.
ENV GENIESIM_SERVER_CUROBO_MODE=off

# ----- ROS 2 environment for rclpy -----
ENV RMW_IMPLEMENTATION=rmw_fastrtps_cpp
ENV GENIESIM_SKIP_ROS_RECORDING=1

# ----- BlueprintPipeline server patches -----
ARG CACHE_BUST_PATCHES=1
COPY tools/geniesim_adapter/deployment/patches/ /tmp/patches/
COPY tools/geniesim_adapter/contact_report.proto /tmp/contact_report.proto
RUN ${ISAAC_SIM_PATH}/python.sh -m pip install grpcio-tools 2>/dev/null || true \
    && ${ISAAC_SIM_PATH}/python.sh -m grpc_tools.protoc \
        -I/tmp \
        --python_out=/opt/geniesim/source/data_collection/common/aimdk/protocol \
        /tmp/contact_report.proto \
    && rm /tmp/contact_report.proto
RUN ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_omnigraph_dedup.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_data_collector_render_config.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_camera_handler.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_object_pose_handler.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_ee_pose_handler.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_stage_diagnostics.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_observation_cameras.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_grpc_server.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/_apply_safe_float.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_xforms_safe_rotation.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_articulation_guard.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_autoplay.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_contact_report.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_joint_efforts_handler.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_grpc_generic_handler.py \
    && ${ISAAC_SIM_PATH}/python.sh /tmp/patches/patch_get_observation.py \
    && rm -rf /tmp/patches

# ----- Bake ROS 2 environment for rclpy -----
RUN _ROS2_BASE="" \
    && if [ -d "${ISAAC_SIM_PATH}/exts/isaacsim.ros2.bridge/jazzy/lib" ]; then \
         _ROS2_BASE="${ISAAC_SIM_PATH}/exts/isaacsim.ros2.bridge/jazzy"; \
       elif [ -d "${ISAAC_SIM_PATH}/exts/isaacsim.ros2.bridge/humble/lib" ]; then \
         _ROS2_BASE="${ISAAC_SIM_PATH}/exts/isaacsim.ros2.bridge/humble"; \
       fi \
    && if [ -n "${_ROS2_BASE}" ]; then \
         printf 'export LD_LIBRARY_PATH="%s/lib:${LD_LIBRARY_PATH:-}"\nexport PYTHONPATH="%s/rclpy:%s:${PYTHONPATH:-}"\n' \
           "${_ROS2_BASE}" "${_ROS2_BASE}" "${_ROS2_BASE}" \
           > /etc/geniesim-ros2.env; \
       else \
         touch /etc/geniesim-ros2.env; \
       fi

# ----- Pre-bake robot USD assets -----
ENV SIM_ASSETS=/sim-assets
ENV SIM_ASSETS_ROBOTS=/sim-assets/robots
COPY scripts/robot_asset_manifest.txt /tmp/robot_asset_manifest.txt
COPY scripts/download_robot_assets.sh /tmp/download_robot_assets.sh
RUN chmod +x /tmp/download_robot_assets.sh \
    && /tmp/download_robot_assets.sh ${SIM_ASSETS_ROBOTS} /tmp/robot_asset_manifest.txt \
    && rm /tmp/download_robot_assets.sh /tmp/robot_asset_manifest.txt

# Mark that this is a pre-baked image (used by bootstrap fast-path)
RUN touch /opt/.geniesim-prebaked

# Ensure torch packaging symlinks are replaced with real files.
RUN TORCH_PKG="${ISAAC_SIM_PATH}/exts/omni.isaac.ml_archive/pip_prebundle/torch/_vendor/packaging" \
    && REAL_PKG="${ISAAC_SIM_PATH}/kit/python/lib/python3.11/site-packages/packaging" \
    && for f in _structures.py _manylinux.py _musllinux.py; do \
         rm -f "${TORCH_PKG}/${f}" 2>/dev/null || true; \
         cp "${REAL_PKG}/${f}" "${TORCH_PKG}/${f}" 2>/dev/null || true; \
       done

WORKDIR /workspace/BlueprintPipeline

COPY tools/ /workspace/BlueprintPipeline/tools/

RUN chmod +x /workspace/BlueprintPipeline/tools/geniesim_adapter/deployment/start_geniesim_server.sh

ENV PYTHONUNBUFFERED=1
ENV OMNI_KIT_ALLOW_ROOT=1

ENTRYPOINT ["/bin/bash", "-lc"]
CMD ["./tools/geniesim_adapter/deployment/start_geniesim_server.sh"]
