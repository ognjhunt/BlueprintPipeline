# =============================================================================
# Text-First Source Pipeline Configuration
# =============================================================================
#
# Environment variables for the source-orchestrator and text Stage 1 jobs.
# Source these in your shell or set them in Cloud Run / Workflow env config.
#
# Usage:
#   source configs/text_source.env
#
# =============================================================================

# --- Source Orchestrator ---

# Default source mode when scene_request.json omits source_mode.
# Options: text
DEFAULT_SOURCE_MODE=text

# Default text backend used when scene_request.json omits text_backend.
# Options: scenesmith, sage, hybrid_serial
TEXT_BACKEND_DEFAULT=hybrid_serial
TEXT_BACKEND_ALLOWLIST=scenesmith,sage,hybrid_serial

# Runtime hint for text Stage 1 execution.
# Options: vm (run on existing GPU VM), cloudrun (Cloud Run jobs)
TEXT_GEN_RUNTIME=vm

# Require Arena export success in source-orchestrator Stage 5.
# When true, text-mode scene completion requires Stage 2-5 all succeed.
ARENA_EXPORT_REQUIRED=true

# Maximum allowed seed_count per scene_request.json.
# Prevents runaway cost from excessively large fan-out requests.
TEXT_GEN_MAX_SEEDS=16

# --- Text Scene Gen Job ---

# Profile labels injected into text-scene-gen-job for tier selection.
# These are metadata labels; the actual tier behavior is controlled by QualityTier enum.
TEXT_GEN_STANDARD_PROFILE=standard_v1
TEXT_GEN_PREMIUM_PROFILE=premium_v1

# Override the quality tier regardless of request payload.
# Leave empty to respect the request's quality_tier field.
# Options: standard, premium
# TEXT_GEN_QUALITY_TIER=

# Enable LLM-based scene planning (requires API keys for provider chain).
# When true (default), attempts LLM plan first and falls back to deterministic templates on failure.
# Options: true, false
TEXT_GEN_USE_LLM=true

# LLM retry controls for text scene planning.
TEXT_GEN_LLM_MAX_ATTEMPTS=3
TEXT_GEN_LLM_RETRY_BACKOFF_SECONDS=2

# OpenRouter-first provider chain controls.
# Applied when scene requests use provider_policy=openrouter_qwen_primary.
# API key precedence: TEXT_OPENROUTER_API_KEY -> OPENROUTER_API_KEY.
TEXT_OPENROUTER_API_KEY=
TEXT_OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
TEXT_OPENROUTER_MODEL_CHAIN=qwen/qwen3.5-397b-a17b,moonshotai/kimi-k2.5
TEXT_OPENROUTER_INCLUDE_LEGACY_FALLBACK=true

# --- Text Scene Adapter Asset Materialization ---
#
# Try retrieving real USD assets from library prefixes before falling back to
# generated placeholder geometry.
TEXT_ASSET_RETRIEVAL_ENABLED=true
TEXT_ASSET_LIBRARY_PREFIXES=scenes
TEXT_ASSET_LIBRARY_MAX_FILES=2500
TEXT_ASSET_LIBRARY_MIN_SCORE=0.25
TEXT_ASSET_RETRIEVAL_MODE=ann_shadow
TEXT_ASSET_ANN_ENABLED=true
TEXT_ASSET_ANN_TOP_K=40
TEXT_ASSET_ANN_MIN_SCORE=0.28
TEXT_ASSET_ANN_MAX_RERANK=20
TEXT_ASSET_ANN_NAMESPACE=assets-v1
TEXT_ASSET_LEXICAL_FALLBACK_ENABLED=true
TEXT_ASSET_ROLLOUT_STATE_PREFIX=automation/asset_retrieval_rollout
TEXT_ASSET_ROLLOUT_MIN_DECISIONS=500
TEXT_ASSET_ROLLOUT_MIN_HIT_RATE=0.95
TEXT_ASSET_ROLLOUT_MAX_ERROR_RATE=0.01
TEXT_ASSET_ROLLOUT_MAX_P95_MS=400
TEXT_ASSET_CATALOG_ENABLED=true
TEXT_ASSET_REPLICATION_ENABLED=true
TEXT_ASSET_REPLICATION_QUEUE_PREFIX=automation/asset_replication/queue
TEXT_ASSET_REPLICATION_TARGET=backblaze_b2
TEXT_ASSET_REPLICATION_TARGET_PREFIX=assets
TEXT_ASSET_EMBEDDING_QUEUE_PREFIX=automation/asset_embedding/queue
TEXT_ASSET_EMBEDDING_PROCESSED_PREFIX=automation/asset_embedding/processed
TEXT_ASSET_EMBEDDING_FAILED_PREFIX=automation/asset_embedding/failed
TEXT_ASSET_EMBEDDING_MODEL=text-embedding-3-small
TEXT_ASSET_EMBEDDING_BACKEND=openai

# ANN/vector backend defaults for 100k+ retrieval.
VECTOR_STORE_PROVIDER=vertex
VECTOR_STORE_PROJECT_ID=
VECTOR_STORE_LOCATION=
VECTOR_STORE_NAMESPACE=assets-v1
VECTOR_STORE_DIMENSION=1536
VERTEX_INDEX_ENDPOINT=
VERTEX_DEPLOYED_INDEX_ID=

# Optional real mesh generation fallback when retrieval misses.
# SceneSmith-aligned provider chain defaults to sam3d first, then hunyuan3d fallback.
TEXT_ASSET_GENERATION_ENABLED=true
TEXT_ASSET_GENERATION_PROVIDER=sam3d
TEXT_ASSET_GENERATION_PROVIDER_CHAIN=sam3d,hunyuan3d
TEXT_ASSET_GENERATED_CACHE_ENABLED=true
TEXT_ASSET_GENERATED_CACHE_PREFIX=asset-library/generated-text
TEXT_SAM3D_API_HOST=
TEXT_SAM3D_TEXT_ENDPOINTS=/openapi/v1/text-to-3d,/v1/text-to-3d
TEXT_SAM3D_TIMEOUT_SECONDS=1800
TEXT_SAM3D_POLL_SECONDS=10
TEXT_HUNYUAN_API_HOST=
TEXT_HUNYUAN_TEXT_ENDPOINTS=/openapi/v1/text-to-3d,/v1/text-to-3d
TEXT_HUNYUAN_TIMEOUT_SECONDS=1800
TEXT_HUNYUAN_POLL_SECONDS=10

# --- Backblaze B2 Replication Worker ---
# Used by asset-replication-job and asset-replication-pipeline.
B2_S3_ENDPOINT=
B2_BUCKET=
B2_REGION=us-west-000
B2_KEY_ID_SECRET=b2-key-id
B2_APPLICATION_KEY_SECRET=b2-application-key
TEXT_ASSET_REPLICATION_PROCESSED_PREFIX=automation/asset_replication/processed
TEXT_ASSET_REPLICATION_FAILED_PREFIX=automation/asset_replication/failed
TEXT_ASSET_REPLICATION_MAX_ITEMS=10

# --- VM Text Runtime ---
#
# Used only when TEXT_GEN_RUNTIME=vm.
# The source-orchestrator launches Cloud Build + SSH and runs both text jobs on this VM.
TEXT_GEN_VM_NAME=isaac-sim-ubuntu
TEXT_GEN_VM_ZONE=us-east1-c
TEXT_GEN_VM_REPO_DIR=~/BlueprintPipeline
TEXT_GEN_VM_TIMEOUT_SECONDS=2400

# --- SceneSmith / SAGE runtime ---
SCENESMITH_RUNTIME_MODE=cloudrun
# Example local VM wrapper endpoint:
# SCENESMITH_SERVER_URL=http://127.0.0.1:8081/v1/generate
SCENESMITH_SERVER_URL=
SCENESMITH_TIMEOUT_SECONDS=1800
SAGE_RUNTIME_MODE=cloudrun
# Example local VM wrapper endpoint:
# SAGE_SERVER_URL=http://127.0.0.1:8082/v1/refine
SAGE_SERVER_URL=
SAGE_TIMEOUT_SECONDS=900
# Strict live-backend enforcement.
SCENESMITH_LIVE_REQUIRED=true
SAGE_LIVE_REQUIRED=true
TEXT_ENFORCE_LIVE_BACKENDS=false
TEXT_SAGE_ACTION_DEMO_ENABLED=false

# --- VLM Quality Audit (Genie Sim Export) ---

# Enable VLM episode quality audit during Genie Sim export/import.
# Set to 1 to enable, 0 to disable.
# Default in genie-sim-export-pipeline.yaml: 1
ENABLE_VLM_QUALITY_AUDIT=1

# --- Prompt Engine / Daily Text Autonomy ---
#
# Used by text-request-emitter-job and text-autonomy-daily workflow.
TEXT_PROMPT_USE_LLM=true
TEXT_PROMPT_LLM_MAX_ATTEMPTS=3
TEXT_PROMPT_LLM_RETRY_BACKOFF_SECONDS=2
TEXT_PROMPT_LLM_REASONING_EFFORT=high

TEXT_AUTONOMY_STATE_PREFIX=automation/text_daily
TEXT_AUTONOMY_TIMEZONE=America/New_York
TEXT_DAILY_QUOTA=1
TEXT_DAILY_PAUSE_AFTER_CONSEC_FAILS=3
TEXT_AUTONOMY_PROVIDER_POLICY=openrouter_qwen_primary
TEXT_AUTONOMY_TEXT_BACKEND=hybrid_serial
TEXT_AUTONOMY_QUALITY_TIER=premium
TEXT_AUTONOMY_SEED_COUNT=1
TEXT_AUTONOMY_EMITTER_JOB_NAME=text-request-emitter-job
TEXT_AUTONOMY_EMITTER_TIMEOUT_SECONDS=900
TEXT_AUTONOMY_SOURCE_WAIT_TIMEOUT_SECONDS=21600
TEXT_AUTONOMY_SOURCE_WAIT_POLL_SECONDS=30
