// Genie Sim Data Collection gRPC Service Definition
//
// This protobuf file defines the gRPC service for communication between
// the BlueprintPipeline and the Genie Sim data collection server running
// inside Isaac Sim.
//
// Based on the Genie Sim 3.0 architecture:
// - Repository: https://github.com/AgibotTech/genie_sim
// - Port: 50051 (default gRPC port)
//
// Usage:
//   1. Generate Python stubs: python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. geniesim_grpc.proto
//   2. Import: from geniesim_grpc_pb2 import *
//             from geniesim_grpc_pb2_grpc import *

syntax = "proto3";

package geniesim;

option python_package = "geniesim_grpc";

// =============================================================================
// Common Types
// =============================================================================

// 3D vector for positions
message Vector3 {
  double x = 1;
  double y = 2;
  double z = 3;
}

// Quaternion for orientations (w, x, y, z)
message Quaternion {
  double w = 1;
  double x = 2;
  double y = 3;
  double z = 4;
}

// 6D pose (position + orientation)
message Pose {
  Vector3 position = 1;
  Quaternion orientation = 2;
}

// Joint state
message JointState {
  repeated double positions = 1;
  repeated double velocities = 2;
  repeated double efforts = 3;
  repeated string names = 4;
}

// =============================================================================
// Camera Data
// =============================================================================

// Camera image data
message CameraImage {
  bytes rgb_data = 1;           // RGB image data (compressed PNG or raw)
  bytes depth_data = 2;         // Depth image data (16-bit or float)
  bytes semantic_data = 3;      // Semantic segmentation labels
  bytes instance_data = 4;      // Instance segmentation labels
  int32 width = 5;
  int32 height = 6;
  string encoding = 7;          // "rgb8", "rgba8", "32fc1", etc.
  string camera_id = 8;
  Pose camera_pose = 9;
  double timestamp = 10;
}

// Multi-camera observation
message CameraObservation {
  repeated CameraImage images = 1;
}

// =============================================================================
// Robot State
// =============================================================================

// Full robot state observation
message RobotState {
  JointState joint_state = 1;
  Pose end_effector_pose = 2;
  double gripper_width = 3;
  bool gripper_is_grasping = 4;
  repeated Pose link_poses = 5;
  repeated string link_names = 6;
}

// =============================================================================
// Object State
// =============================================================================

// Object state in scene
message ObjectState {
  string object_id = 1;
  Pose pose = 2;
  Vector3 linear_velocity = 3;
  Vector3 angular_velocity = 4;
  Vector3 dimensions = 5;
  string category = 6;
  bool is_articulated = 7;
  repeated double joint_positions = 8;  // For articulated objects
}

// Scene state (all objects)
message SceneState {
  repeated ObjectState objects = 1;
  double simulation_time = 2;
  int64 step_count = 3;
}

// =============================================================================
// Commands
// =============================================================================

// Command types (mirrors CommandType enum in local_framework.py)
enum CommandType {
  COMMAND_UNKNOWN = 0;
  GET_CAMERA_DATA = 1;
  LINEAR_MOVE = 2;
  SET_JOINT_POSITION = 3;
  GET_GRIPPER_STATE = 4;
  GET_OBJECT_POSE = 5;
  ADD_OBJECT = 6;
  GET_ROBOT_LINK_POSE = 7;
  GET_JOINT_POSITION = 8;
  SET_GRIPPER_STATE = 9;
  GET_OBSERVATION = 11;
  RESET = 12;
  ATTACH_OBJ = 13;
  DETACH_OBJ = 14;
  TASK_STATUS = 16;
  EXIT = 17;
  GET_EE_POSE = 18;
  GET_IK_STATUS = 19;
  INIT_ROBOT = 21;
  ADD_CAMERA = 22;
  SET_OBJECT_POSE = 24;
  SET_TRAJECTORY_LIST = 25;
  GET_OBJECT_JOINT = 26;
  SET_TARGET_POINT = 27;
  SET_FRAME_STATE = 28;
  SET_LIGHT = 30;
  GET_PART_DOF_JOINT = 32;
  SET_LINEAR_VELOCITY = 33;
  SET_CODE_FACE_ORIENTATION = 34;
  ATTACH_OBJ_TO_PARENT = 50;
  DETACH_OBJ_FROM_PARENT = 51;
  REMOVE_OBJS_FROM_OBSTACLE = 52;
  SET_TASK_METRIC = 53;
  STORE_CURRENT_STATE = 54;
  PLAYBACK = 55;
  GET_CHECKER_STATUS = 56;
}

// =============================================================================
// Request/Response Messages
// =============================================================================

// Generic command request
message CommandRequest {
  CommandType command_type = 1;
  bytes payload = 2;  // JSON-encoded command-specific data
}

// Generic command response
message CommandResponse {
  bool success = 1;
  string error_message = 2;
  bytes payload = 3;  // JSON-encoded response data
}

// --- Observation Request/Response ---

message GetObservationRequest {
  bool include_images = 1;
  bool include_depth = 2;
  bool include_semantic = 3;
  repeated string camera_ids = 4;
}

message GetObservationResponse {
  bool success = 1;
  RobotState robot_state = 2;
  SceneState scene_state = 3;
  CameraObservation camera_observation = 4;
  double timestamp = 5;
}

// --- Joint Position Control ---

message SetJointPositionRequest {
  repeated double positions = 1;
  repeated double velocities = 2;  // Optional velocity targets
  double duration = 3;             // Optional move duration
  bool wait_for_completion = 4;
}

message SetJointPositionResponse {
  bool success = 1;
  string error_message = 2;
  JointState current_state = 3;
}

message GetJointPositionRequest {
  // Empty - just get current positions
}

message GetJointPositionResponse {
  bool success = 1;
  JointState joint_state = 2;
}

// --- End-Effector Control ---

message GetEEPoseRequest {
  string ee_link_name = 1;  // Optional, uses default if empty
}

message GetEEPoseResponse {
  bool success = 1;
  Pose pose = 2;
}

message LinearMoveRequest {
  Pose target_pose = 1;
  double velocity = 2;
  double acceleration = 3;
  bool wait_for_completion = 4;
}

message LinearMoveResponse {
  bool success = 1;
  string error_message = 2;
  bool planning_success = 3;
  bool execution_success = 4;
}

// --- Gripper Control ---

message SetGripperStateRequest {
  double width = 1;           // Target gripper width
  double force = 2;           // Grasping force
  bool wait_for_completion = 3;
}

message SetGripperStateResponse {
  bool success = 1;
  string error_message = 2;
  double current_width = 3;
  bool is_grasping = 4;
}

message GetGripperStateRequest {
  // Empty
}

message GetGripperStateResponse {
  bool success = 1;
  double width = 2;
  bool is_grasping = 3;
  double force = 4;
}

// --- Object Manipulation ---

message GetObjectPoseRequest {
  string object_id = 1;
}

message GetObjectPoseResponse {
  bool success = 1;
  Pose pose = 2;
  string error_message = 3;
}

message SetObjectPoseRequest {
  string object_id = 1;
  Pose pose = 2;
}

message SetObjectPoseResponse {
  bool success = 1;
  string error_message = 2;
}

message AttachObjectRequest {
  string object_id = 1;
  string link_name = 2;  // Robot link to attach to
}

message AttachObjectResponse {
  bool success = 1;
  string error_message = 2;
}

message DetachObjectRequest {
  string object_id = 1;
}

message DetachObjectResponse {
  bool success = 1;
  string error_message = 2;
}

// --- Trajectory Execution ---

message TrajectoryPoint {
  repeated double positions = 1;
  repeated double velocities = 2;
  repeated double accelerations = 3;
  double time_from_start = 4;
}

message SetTrajectoryRequest {
  repeated TrajectoryPoint points = 1;
  double execution_speed = 2;  // Speed multiplier (1.0 = normal)
  bool wait_for_completion = 3;
}

message SetTrajectoryResponse {
  bool success = 1;
  string error_message = 2;
  int32 points_executed = 3;
  double execution_time = 4;
}

// --- Recording ---

message StartRecordingRequest {
  string episode_id = 1;
  string output_directory = 2;
  repeated string camera_ids = 3;
  double fps = 4;
  bool include_depth = 5;
  bool include_semantic = 6;
}

message StartRecordingResponse {
  bool success = 1;
  string error_message = 2;
  string recording_path = 3;
}

message StopRecordingRequest {
  bool save_metadata = 1;
}

message StopRecordingResponse {
  bool success = 1;
  string error_message = 2;
  int32 frames_recorded = 3;
  double duration_seconds = 4;
  string recording_path = 5;
}

// --- Environment Control ---

message ResetRequest {
  bool reset_robot = 1;
  bool reset_objects = 2;
  string scene_path = 3;  // Optional: load new scene
}

message ResetResponse {
  bool success = 1;
  string error_message = 2;
}

message InitRobotRequest {
  string robot_type = 1;
  string urdf_path = 2;
  Pose base_pose = 3;
  repeated double initial_joint_positions = 4;
}

message InitRobotResponse {
  bool success = 1;
  string error_message = 2;
  int32 num_joints = 3;
  repeated string joint_names = 4;
}

// --- Camera Setup ---

message AddCameraRequest {
  string camera_id = 1;
  Pose pose = 2;
  string parent_link = 3;  // Attach to robot link (empty = world frame)
  int32 width = 4;
  int32 height = 5;
  double fov = 6;
  double near_clip = 7;
  double far_clip = 8;
}

message AddCameraResponse {
  bool success = 1;
  string error_message = 2;
}

// --- IK Status ---

message GetIKStatusRequest {
  Pose target_pose = 1;
  repeated double seed_positions = 2;
}

message GetIKStatusResponse {
  bool success = 1;
  bool ik_solvable = 2;
  repeated double solution = 3;
  string error_message = 4;
}

// --- Task Status ---

message TaskStatusRequest {
  string task_id = 1;
}

message TaskStatusResponse {
  bool success = 1;
  string status = 2;  // "pending", "running", "completed", "failed"
  double progress = 3;
  string error_message = 4;
}

// =============================================================================
// Service Definition
// =============================================================================

// Main Genie Sim data collection service
service GenieSimService {
  // Observation and State
  rpc GetObservation(GetObservationRequest) returns (GetObservationResponse);
  rpc GetJointPosition(GetJointPositionRequest) returns (GetJointPositionResponse);
  rpc GetEEPose(GetEEPoseRequest) returns (GetEEPoseResponse);
  rpc GetGripperState(GetGripperStateRequest) returns (GetGripperStateResponse);
  rpc GetObjectPose(GetObjectPoseRequest) returns (GetObjectPoseResponse);
  rpc GetIKStatus(GetIKStatusRequest) returns (GetIKStatusResponse);
  rpc GetTaskStatus(TaskStatusRequest) returns (TaskStatusResponse);

  // Robot Control
  rpc SetJointPosition(SetJointPositionRequest) returns (SetJointPositionResponse);
  rpc LinearMove(LinearMoveRequest) returns (LinearMoveResponse);
  rpc SetGripperState(SetGripperStateRequest) returns (SetGripperStateResponse);
  rpc SetTrajectory(SetTrajectoryRequest) returns (SetTrajectoryResponse);
  rpc InitRobot(InitRobotRequest) returns (InitRobotResponse);

  // Object Manipulation
  rpc SetObjectPose(SetObjectPoseRequest) returns (SetObjectPoseResponse);
  rpc AttachObject(AttachObjectRequest) returns (AttachObjectResponse);
  rpc DetachObject(DetachObjectRequest) returns (DetachObjectResponse);

  // Recording
  rpc StartRecording(StartRecordingRequest) returns (StartRecordingResponse);
  rpc StopRecording(StopRecordingRequest) returns (StopRecordingResponse);

  // Environment
  rpc Reset(ResetRequest) returns (ResetResponse);
  rpc AddCamera(AddCameraRequest) returns (AddCameraResponse);

  // Generic command (for less common operations)
  rpc SendCommand(CommandRequest) returns (CommandResponse);

  // Streaming observation (for continuous data collection)
  rpc StreamObservations(GetObservationRequest) returns (stream GetObservationResponse);
}
