main:
  params: [event]
  steps:
    - log_event:
        call: sys.log
        args:
          text: ${event}
          severity: "INFO"
        next: extract

    - extract:
        assign:
          - bucket: ${event.data.bucket}
          - object: ${event.data.name}
          - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - region: "us-central1"
        next: filter_image

    # Kick off only when a single RGB lands under scenes/<sceneId>/images/
    - filter_image:
        switch:
          - condition: ${text.match_regex(object, "(?i)^scenes/[^/]+/images/[^/]+\\.(png|jpg|jpeg)$")}
            next: derive
        next: skip

    - derive:
        assign:
          - parts: ${text.split(object, "/")}
          - sceneId: ${parts[1]}
          - imagesPrefix: ${text.replace_all(object, "/[^/]+$", "")}
          - segPrefix: ${"scenes/" + sceneId + "/seg"}
          - inventoryJson: ${segPrefix + "/inventory.json"}
          - multiviewPrefix: ${"scenes/" + sceneId + "/multiview"}
          - assetsPrefix: ${"scenes/" + sceneId + "/assets"}
          - inventoryAttempts: 0
          - multiviewAttempts: 0
          - assetsAttempts: 0
        next: run_seg_job

    # Step 1: Generate scene inventory using Gemini
    - run_seg_job:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: ${"projects/" + projectId + "/locations/" + region + "/jobs/seg-job"}
          body:
            overrides:
              containerOverrides:
                - env:
                    - name: BUCKET
                      value: ${bucket}
                    - name: IMAGES_PREFIX
                      value: ${imagesPrefix}
                    - name: SEG_PREFIX
                      value: ${segPrefix}
        result: segExec
        next: wait_for_inventory

    - wait_for_inventory:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${inventoryJson}
          result: invObj
        except:
          as: e
          steps:
            - handle_inventory_error:
                next: retry_inventory
        next: run_multiview_job

    - retry_inventory:
        switch:
          - condition: ${inventoryAttempts < 60}
            next: bump_inventory_attempt
        next: fail_inventory

    - bump_inventory_attempt:
        assign:
          - inventoryAttempts: ${inventoryAttempts + 1}
        next: sleep_inventory

    - sleep_inventory:
        call: sys.sleep
        args:
          seconds: 10
        next: wait_for_inventory

    - fail_inventory:
        raise: ${"inventory.json not found at " + inventoryJson}

    # Step 2: Generate isolated object renders using Gemini
    - run_multiview_job:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: ${"projects/" + projectId + "/locations/" + region + "/jobs/multiview-job"}
          body:
            overrides:
              containerOverrides:
                - env:
                    - name: BUCKET
                      value: ${bucket}
                    - name: SCENE_ID
                      value: ${sceneId}
                    - name: SEG_PREFIX
                      value: ${segPrefix}
                    - name: MULTIVIEW_PREFIX
                      value: ${multiviewPrefix}
        result: mvExec
        next: wait_for_multiview

    - wait_for_multiview:
        try:
          call: googleapis.storage.v1.objects.list
          args:
            bucket: ${bucket}
            prefix: ${multiviewPrefix + "/obj_"}
            maxResults: 1
          result: mvList
        except:
          as: e
          steps:
            - handle_mv_error:
                next: retry_multiview
        next: check_multiview

    - check_multiview:
        switch:
          - condition: ${len(mvList.items or []) > 0}
            next: run_sam3d
        next: retry_multiview

    - retry_multiview:
        switch:
          - condition: ${multiviewAttempts < 60}
            next: bump_multiview_attempt
        next: fail_multiview

    - bump_multiview_attempt:
        assign:
          - multiviewAttempts: ${multiviewAttempts + 1}
        next: sleep_multiview

    - sleep_multiview:
        call: sys.sleep
        args:
          seconds: 10
        next: wait_for_multiview

    - fail_multiview:
        raise: ${"No multiview objects found under " + multiviewPrefix}

    # Step 3: Generate 3D models using SAM3D
    - run_sam3d:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: ${"projects/" + projectId + "/locations/" + region + "/jobs/sam3d-job"}
          body:
            overrides:
              containerOverrides:
                - env:
                    - name: BUCKET
                      value: ${bucket}
                    - name: SCENE_ID
                      value: ${sceneId}
                    - name: ASSETS_PREFIX
                      value: ${assetsPrefix}
                    - name: MULTIVIEW_PREFIX
                      value: ${multiviewPrefix}
                    - name: LAYOUT_PREFIX
                      value: ${segPrefix}
        result: sam3dExec
        next: done

    - done:
        return: ${"Gemini pipeline completed for " + object}

    - skip:
        return: ${"ingest skip " + object}
