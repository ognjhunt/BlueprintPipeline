# variation-assets-pipeline.yaml
#
# Google Cloud Workflows pipeline that generates variation assets for domain randomization.
#
# This pipeline:
#   1. Triggers on .replicator_complete marker from replicator-job
#   2. Runs variation-gen-job to generate variation asset specifications
#   3. Runs simready-job to add physics properties to the assets
#
# Note: With 3D-RE-GEN pipeline, 3D model generation is handled by regen3d-job.
#
# Trigger: Cloud Storage object finalized event for .replicator_complete
#
# The generated variation assets are placed in scenes/{sceneId}/variation_assets/
# and can be used by Replicator scripts for domain randomization.

main:
  params: [event]
  steps:
    - log_event:
        call: sys.log
        args:
          text: ${event}
          severity: "INFO"
        next: extract

    - extract:
        assign:
          - bucket: ${event.data.bucket}
          - object: ${event.data.name}
          - projectId: '${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}'
          - region: "us-central1"
        next: filter_replicator_complete

    - filter_replicator_complete:
        switch:
          - condition: '${text.match_regex(object, "^scenes/.+/replicator/\\.replicator_complete$")}'
            next: derive
        next: skip

    - derive:
        assign:
          - parts: '${text.split(object, "/")}'
          - sceneId: ${parts[1]}
          - replicatorPrefix: '${"scenes/" + sceneId + "/replicator"}'
          - variationAssetsPrefix: '${"scenes/" + sceneId + "/variation_assets"}'
          - variationGenJobName: "variation-gen-job"
          - variationGenTimeoutSeconds: 1800
          - simreadyJobName: "simready-job"
          - simreadyTimeoutSeconds: 3600
        next: log_start

    - log_start:
        call: sys.log
        args:
          text: '${"Variation assets pipeline triggered for scene " + sceneId}'
          severity: "INFO"
        next: init_variation_gen_metrics

    - init_variation_gen_metrics:
        assign:
          - variationGenStartTime: '${time.format(sys.now())}'
        next: emit_variation_gen_metrics_start

    - emit_variation_gen_metrics_start:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "start"
            workflow: "variation-assets-pipeline"
            job: ${variationGenJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${variationGenTimeoutSeconds}
            duration_seconds: 0
            timeout_usage_ratio: 0
            timed_out: false
            status: "STARTED"
            start_time: ${variationGenStartTime}
          severity: "INFO"
        next: run_variation_gen_job

    # =========================================================================
    # Stage 1: Generate variation asset specifications
    # =========================================================================

    - run_variation_gen_job:
        try:
          call: googleapis.run.v2.projects.locations.jobs.run
          args:
            name: '${"projects/" + projectId + "/locations/" + region + "/jobs/" + variationGenJobName}'
            body:
              overrides:
                containerOverrides:
                  - env:
                      - name: BUCKET
                        value: ${bucket}
                      - name: SCENE_ID
                        value: ${sceneId}
                      - name: REPLICATOR_PREFIX
                        value: ${replicatorPrefix}
                      - name: VARIATION_ASSETS_PREFIX
                        value: ${variationAssetsPrefix}
                      # Generate only required and recommended assets by default
                      # Set to empty string to generate all
                      - name: PRIORITY_FILTER
                        value: ""
              timeout: '${string(variationGenTimeoutSeconds) + "s"}'
          result: variationGenExec
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 3
          backoff:
            initial_delay: 2
            max_delay: 30
            multiplier: 2
        except:
          as: e
          steps:
            - log_variation_gen_retry_exhausted:
                call: sys.log
                args:
                  data:
                    bp_metric: "job_retry_exhausted"
                    workflow: "variation-assets-pipeline"
                    job: ${variationGenJobName}
                    scene_id: ${sceneId}
                    retry_max: 3
                    error: ${e.message}
                  severity: "ERROR"
            - log_variation_gen_job_error:
                call: sys.log
                args:
                  text: '${"Failed to start variation-gen job after retries: " + e.message}'
                  severity: "ERROR"
            - raise_variation_gen_job_error:
                raise: ${e}
        next: set_variation_gen_execution_name

    - set_variation_gen_execution_name:
        assign:
          - variationGenExecutionName: '${if(variationGenExec.metadata != null and variationGenExec.metadata.name != null, variationGenExec.metadata.name, variationGenExec.name)}'
        next: wait_for_variation_gen

    - wait_for_variation_gen:
        call: googleapis.run.v2.projects.locations.jobs.executions.get
        args:
          name: ${variationGenExecutionName}
        result: variationGenStatus
        next: check_variation_gen_status

    - check_variation_gen_status:
        assign:
          - variationGenState: '${if(variationGenStatus.state != null, variationGenStatus.state, if(variationGenStatus.status != null, variationGenStatus.status.state, null))}'
          - variationGenFailedCount: '${if(variationGenStatus.failedCount != null, variationGenStatus.failedCount, if(variationGenStatus.status != null, variationGenStatus.status.failedCount, null))}'
          - variationGenSucceededCount: '${if(variationGenStatus.succeededCount != null, variationGenStatus.succeededCount, if(variationGenStatus.status != null, variationGenStatus.status.succeededCount, null))}'
        next: variation_gen_status_switch

    - variation_gen_status_switch:
        switch:
          - condition: '${variationGenState == "FAILED" or (variationGenFailedCount != null and variationGenFailedCount > 0)}'
            next: variation_gen_failed
          - condition: '${variationGenState == "SUCCEEDED" or (variationGenSucceededCount != null and variationGenSucceededCount > 0)}'
            next: log_variation_gen_complete
        next: wait_variation_gen_poll

    - wait_variation_gen_poll:
        call: sys.sleep
        args:
          seconds: 10
        next: wait_for_variation_gen

    - log_variation_gen_complete:
        assign:
          - variationGenEndTime: '${time.format(sys.now())}'
          - variationGenDurationSeconds: '${time.parse(variationGenEndTime) - time.parse(variationGenStartTime)}'
          - variationGenTimeoutUsageRatio: '${variationGenDurationSeconds / variationGenTimeoutSeconds}'
          - variationGenTimedOut: '${variationGenDurationSeconds >= variationGenTimeoutSeconds}'
        next: emit_variation_gen_metrics_complete

    - emit_variation_gen_metrics_complete:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "complete"
            workflow: "variation-assets-pipeline"
            job: ${variationGenJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${variationGenTimeoutSeconds}
            duration_seconds: ${variationGenDurationSeconds}
            timeout_usage_ratio: ${variationGenTimeoutUsageRatio}
            timed_out: ${variationGenTimedOut}
            status: "SUCCEEDED"
            start_time: ${variationGenStartTime}
            end_time: ${variationGenEndTime}
          severity: "INFO"
        next: log_variation_gen_complete_message

    - log_variation_gen_complete_message:
        call: sys.log
        args:
          text: '${"Variation generation completed for scene " + sceneId + " - starting simready-job"}'
          severity: "INFO"
        next: check_variation_assets_exist

    - variation_gen_failed:
        assign:
          - errorMsg: '${"Variation generation job FAILED for scene " + sceneId}'
          - variationGenEndTime: '${time.format(sys.now())}'
          - variationGenDurationSeconds: '${time.parse(variationGenEndTime) - time.parse(variationGenStartTime)}'
          - variationGenTimeoutUsageRatio: '${variationGenDurationSeconds / variationGenTimeoutSeconds}'
          - variationGenTimedOut: '${variationGenDurationSeconds >= variationGenTimeoutSeconds}'
        next: emit_variation_gen_metrics_failed

    - emit_variation_gen_metrics_failed:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "complete"
            workflow: "variation-assets-pipeline"
            job: ${variationGenJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${variationGenTimeoutSeconds}
            duration_seconds: ${variationGenDurationSeconds}
            timeout_usage_ratio: ${variationGenTimeoutUsageRatio}
            timed_out: ${variationGenTimedOut}
            status: "FAILED"
            start_time: ${variationGenStartTime}
            end_time: ${variationGenEndTime}
          severity: "ERROR"
        next: log_variation_gen_error

    - log_variation_gen_error:
        call: sys.log
        args:
          text: ${errorMsg}
          severity: "ERROR"
        next: raise_variation_gen_error

    - raise_variation_gen_error:
        raise: ${errorMsg}

    # =========================================================================
    # Check if any assets were generated before proceeding
    # =========================================================================

    - check_variation_assets_exist:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: '${variationAssetsPrefix + "/variation_assets.json"}'
          result: variationAssetsJson
        except:
          as: e
          steps:
            - no_assets_generated:
                call: sys.log
                args:
                  text: '${"No variation assets were generated for scene " + sceneId + " - pipeline complete"}'
                  severity: "INFO"
                next: done_no_assets
        next: init_simready_metrics

    # =========================================================================
    # Stage 2: Add physics properties to variation assets
    # =========================================================================

    - init_simready_metrics:
        assign:
          - simreadyStartTime: '${time.format(sys.now())}'
        next: emit_simready_metrics_start

    - emit_simready_metrics_start:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "start"
            workflow: "variation-assets-pipeline"
            job: ${simreadyJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${simreadyTimeoutSeconds}
            duration_seconds: 0
            timeout_usage_ratio: 0
            timed_out: false
            status: "STARTED"
            start_time: ${simreadyStartTime}
          severity: "INFO"
        next: run_simready_job

    - run_simready_job:
        try:
          call: googleapis.run.v2.projects.locations.jobs.run
          args:
            name: '${"projects/" + projectId + "/locations/" + region + "/jobs/" + simreadyJobName}'
            body:
              overrides:
                containerOverrides:
                  - env:
                      - name: BUCKET
                        value: ${bucket}
                      - name: SCENE_ID
                        value: '${sceneId + "_variation"}'
                      - name: ASSETS_PREFIX
                        value: ${variationAssetsPrefix}
                      - name: SIMREADY_PHYSICS_MODE
                        value: "deterministic"
              timeout: '${string(simreadyTimeoutSeconds) + "s"}'
          result: simreadyExec
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 3
          backoff:
            initial_delay: 2
            max_delay: 30
            multiplier: 2
        except:
          as: e
          steps:
            - log_simready_retry_exhausted:
                call: sys.log
                args:
                  data:
                    bp_metric: "job_retry_exhausted"
                    workflow: "variation-assets-pipeline"
                    job: ${simreadyJobName}
                    scene_id: ${sceneId}
                    retry_max: 3
                    error: ${e.message}
                  severity: "ERROR"
            - log_simready_job_error:
                call: sys.log
                args:
                  text: '${"Failed to start simready job after retries: " + e.message}'
                  severity: "ERROR"
            - raise_simready_job_error:
                raise: ${e}
        next: set_simready_execution_name

    - set_simready_execution_name:
        assign:
          - simreadyExecutionName: '${if(simreadyExec.metadata != null and simreadyExec.metadata.name != null, simreadyExec.metadata.name, simreadyExec.name)}'
        next: wait_for_simready

    - wait_for_simready:
        call: googleapis.run.v2.projects.locations.jobs.executions.get
        args:
          name: ${simreadyExecutionName}
        result: simreadyStatus
        next: check_simready_status

    - check_simready_status:
        assign:
          - simreadyState: '${if(simreadyStatus.state != null, simreadyStatus.state, if(simreadyStatus.status != null, simreadyStatus.status.state, null))}'
          - simreadyFailedCount: '${if(simreadyStatus.failedCount != null, simreadyStatus.failedCount, if(simreadyStatus.status != null, simreadyStatus.status.failedCount, null))}'
          - simreadySucceededCount: '${if(simreadyStatus.succeededCount != null, simreadyStatus.succeededCount, if(simreadyStatus.status != null, simreadyStatus.status.succeededCount, null))}'
        next: simready_status_switch

    - simready_status_switch:
        switch:
          - condition: '${simreadyState == "FAILED" or (simreadyFailedCount != null and simreadyFailedCount > 0)}'
            next: simready_failed
          - condition: '${simreadyState == "SUCCEEDED" or (simreadySucceededCount != null and simreadySucceededCount > 0)}'
            next: log_simready_complete
        next: wait_simready_poll

    - wait_simready_poll:
        call: sys.sleep
        args:
          seconds: 10
        next: wait_for_simready

    - log_simready_complete:
        assign:
          - simreadyEndTime: '${time.format(sys.now())}'
          - simreadyDurationSeconds: '${time.parse(simreadyEndTime) - time.parse(simreadyStartTime)}'
          - simreadyTimeoutUsageRatio: '${simreadyDurationSeconds / simreadyTimeoutSeconds}'
          - simreadyTimedOut: '${simreadyDurationSeconds >= simreadyTimeoutSeconds}'
        next: emit_simready_metrics_complete

    - emit_simready_metrics_complete:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "complete"
            workflow: "variation-assets-pipeline"
            job: ${simreadyJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${simreadyTimeoutSeconds}
            duration_seconds: ${simreadyDurationSeconds}
            timeout_usage_ratio: ${simreadyTimeoutUsageRatio}
            timed_out: ${simreadyTimedOut}
            status: "SUCCEEDED"
            start_time: ${simreadyStartTime}
            end_time: ${simreadyEndTime}
          severity: "INFO"
        next: log_simready_complete_message

    - log_simready_complete_message:
        call: sys.log
        args:
          text: '${"Simready job completed for scene " + sceneId + " variation assets"}'
          severity: "INFO"
        next: write_completion_marker

    - simready_failed:
        assign:
          - simreadyEndTime: '${time.format(sys.now())}'
          - simreadyDurationSeconds: '${time.parse(simreadyEndTime) - time.parse(simreadyStartTime)}'
          - simreadyTimeoutUsageRatio: '${simreadyDurationSeconds / simreadyTimeoutSeconds}'
          - simreadyTimedOut: '${simreadyDurationSeconds >= simreadyTimeoutSeconds}'
        next: emit_simready_metrics_failed

    - emit_simready_metrics_failed:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "complete"
            workflow: "variation-assets-pipeline"
            job: ${simreadyJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${simreadyTimeoutSeconds}
            duration_seconds: ${simreadyDurationSeconds}
            timeout_usage_ratio: ${simreadyTimeoutUsageRatio}
            timed_out: ${simreadyTimedOut}
            status: "FAILED"
            start_time: ${simreadyStartTime}
            end_time: ${simreadyEndTime}
          severity: "WARNING"
        next: log_simready_failed_message

    - log_simready_failed_message:
        call: sys.log
        args:
          text: '${"WARNING: Simready job failed for scene " + sceneId + " variation assets - assets may not have physics properties"}'
          severity: "WARNING"
        next: write_completion_marker

    # =========================================================================
    # Write completion marker and finish
    # =========================================================================

    - write_completion_marker:
        call: googleapis.storage.v1.objects.insert
        args:
          bucket: ${bucket}
          name: '${variationAssetsPrefix + "/.variation_pipeline_complete"}'
          body:
            contentType: "text/plain"
          uploadType: "media"
          data: '${"Completed at " + time.format(sys.now())}'
        result: markerResult
        next: done

    # =========================================================================
    # Completion states
    # =========================================================================

    - done:
        return:
          status: "SUCCESS"
          scene_id: ${sceneId}
          message: '${"Variation assets pipeline completed for scene " + sceneId}'
          variation_gen_execution: ${variationGenExec.name}
          simready_execution: ${simreadyExec.name}
          outputs:
            variation_assets: '${variationAssetsPrefix}'
            assets_json: '${variationAssetsPrefix + "/variation_assets.json"}'

    - done_no_assets:
        return:
          status: "SUCCESS_NO_ASSETS"
          scene_id: ${sceneId}
          message: '${"No variation assets to generate for scene " + sceneId}'
          variation_gen_execution: ${variationGenExec.name}

    - skip:
        return:
          status: "SKIPPED"
          message: '${"Not a replicator completion marker: " + object}'
