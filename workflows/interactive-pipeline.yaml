main:
  params: [event]
  steps:
    - log_event:
        call: sys.log
        args:
          text: ${event}
          severity: "INFO"
        next: extract

    - extract:
        assign:
          - bucket: ${event.data.bucket}
          - object: ${event.data.name}
          - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - region: "us-central1"
        next: filter_scene_assets

    # Trigger only when scene_assets.json is created by assets-plan.
    - filter_scene_assets:
        switch:
          - condition: ${text.match_regex(object, "^scenes/.+/assets/scene_assets\\.json$")}
            next: derive
        next: skip

    - derive:
        assign:
          - parts: ${text.split(object, "/")}
          - sceneId: ${parts[1]}
          - multiviewPrefix: ${"scenes/" + sceneId + "/multiview"}
          - assetsPrefix: ${"scenes/" + sceneId + "/assets"}
          - layoutPrefix: ${"scenes/" + sceneId + "/layout"}
          # NOTE: Set PARTICULATE_ENDPOINT environment variable for articulation detection.
          - articulationBackend: "particulate"
          - particulateEndpoint: ${sys.get_env("PARTICULATE_ENDPOINT")}
          - jobName: "interactive-job"
          - simreadyJobName: "simready-job"
        next: log_skip_interactive_pipeline

    - log_skip_interactive_pipeline:
        call: sys.log
        args:
          text: ${"Skipping interactive-pipeline entirely (using hunyuan for all objects) for scene " + sceneId + "; creating completion marker"}
          severity: "INFO"
        next: create_completion_marker

    - create_completion_marker:
        try:
          call: googleapis.storage.v1.objects.insert
          args:
            bucket: ${bucket}
            uploadType: "media"
            name: ${assetsPrefix + "/.interactive_complete"}
            body: ${"{\\"scene_id\\": \\"" + sceneId + "\\", \\"status\\": \\"skipped\\", \\"reason\\": \\"Using Hunyuan pipeline for all objects\\", \\"timestamp\\": \\"" + time.format(sys.now()) + "\\"}" }
          result: markerResult
        except:
          as: e
          steps:
            - log_marker_error:
                call: sys.log
                args:
                  text: ${"ERROR: Failed to create .interactive_complete marker: " + e.message}
                  severity: "ERROR"
        next: log_marker_created

    - log_marker_created:
        call: sys.log
        args:
          text: ${"Created .interactive_complete marker for scene " + sceneId + " (using Hunyuan pipeline)"}
          severity: "INFO"
        next: done

    - done:
        return: ${"Interactive + simready pipeline completed for " + object}

    - done_failed:
        return: ${"Interactive + simready pipeline failed for " + object}

    - skip:
        return: ${"interactive skip " + object}