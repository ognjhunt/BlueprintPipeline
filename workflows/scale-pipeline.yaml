main:
  params: [event]
  steps:
    - log_event:
        call: sys.log
        args:
          text: ${event}
          severity: "INFO"
        next: extract

    - extract:
        assign:
          - bucket: ${event.data.bucket}
          - object: ${event.data.name}
          - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - region: "us-central1"
        next: filter_layout_json

    # Only handle scenes/.../layout/scene_layout.json
    - filter_layout_json:
        switch:
          - condition: ${text.match_regex(object, "^scenes/.+/layout/scene_layout\\.json$")}
            next: derive
        next: skip

    - derive:
        assign:
          - parts: ${text.split(object, "/")}
          - sceneId: ${parts[1]}
          - layoutPrefix: ${"scenes/" + sceneId + "/layout"}
          - jobName: "scale-job"
          - doneMarkerPath: ${"scenes/" + sceneId + "/layout/scene_layout_scaled.done"}
        next: check_if_done

    # Check if the output already exists to avoid duplicate processing
    - check_if_done:
        try:
          steps:
            - get_done_marker:
                call: googleapis.storage.v1.objects.get
                args:
                  bucket: ${bucket}
                  object: ${doneMarkerPath}
                result: doneMarkerObject
            - skip_already_done:
                return: ${"scale-job already completed for " + object + " (found done marker)"}
        except:
          as: e
          steps:
            - check_not_found:
                switch:
                  - condition: ${e.code == 404}
                    next: run_scale_job
            - raise_error:
                raise: ${e}
        next: run_scale_job

    - run_scale_job:
        try:
          call: googleapis.run.v2.projects.locations.jobs.run
          args:
            name: ${"projects/" + projectId + "/locations/" + region + "/jobs/" + jobName}
            body:
              overrides:
                containerOverrides:
                  - env:
                      - name: BUCKET
                        value: ${bucket}
                      - name: SCENE_ID
                        value: ${sceneId}
                      - name: LAYOUT_PREFIX
                        value: ${layoutPrefix}
          result: scaleExec
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 3
          backoff:
            initial_delay: 2
            max_delay: 30
            multiplier: 2
        except:
          as: e
          steps:
            - log_job_error:
                call: sys.log
                args:
                  text: ${"ERROR: Failed to start scale-job after retries: " + e.message}
                  severity: "ERROR"
            - write_failure_marker:
                call: googleapis.storage.v1.objects.insert
                args:
                  bucket: ${bucket}
                  name: ${"scenes/" + sceneId + "/layout/.scale_failed"}
                  uploadType: "media"
                  body: ${"{\\"scene_id\\": \\"" + sceneId + "\\", \\"status\\": \\"failed\\", \\"error\\": \\"" + e.message + "\\"}" }
        next: mark_scale_complete

    - mark_scale_complete:
        call: googleapis.storage.v1.objects.insert
        args:
          bucket: ${bucket}
          name: ${"scenes/" + sceneId + "/layout/.scale_complete"}
          uploadType: "media"
          body: ${"{\\"scene_id\\": \\"" + sceneId + "\\", \\"status\\": \\"processing\\", \\"timestamp\\": \\"" + time.format(sys.now()) + "\\"}" }
        result: markerResult
        next: write_assets_ready_marker

    # Write .assets_ready marker to signal that layout processing is complete
    # This triggers downstream pipelines (regen3d-pipeline, etc)
    - write_assets_ready_marker:
        try:
          call: googleapis.storage.v1.objects.insert
          args:
            bucket: ${bucket}
            name: ${"scenes/" + sceneId + "/assets/.assets_ready"}
            uploadType: "media"
            body: ${"{\\"scene_id\\": \\"" + sceneId + "\\", \\"status\\": \\"ready\\", \\"timestamp\\": \\"" + time.format(sys.now()) + "\\"}" }
          result: assetsReadyMarker
        except:
          as: e
          steps:
            - log_assets_ready_error:
                call: sys.log
                args:
                  text: ${"WARNING: Failed to write .assets_ready marker: " + e.message}
                  severity: "WARNING"
        next: done

    - done:
        return: ${"scale-job started for " + object}

    - skip:
        return: ${"scale skip " + object}