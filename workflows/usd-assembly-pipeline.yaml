# usd-assembly-pipeline.yaml
#
# Google Cloud Workflows pipeline that:
#   1. Triggers on completion marker files from hunyuan-job, interactive-job, or simready-job
#   2. Waits for ALL THREE jobs to complete (.hunyuan_complete, .interactive_complete, .simready_complete)
#   3. Runs usd-assembly-job to convert GLB->USDZ and build scene.usda
#
# Trigger: Cloud Storage object finalized event for .hunyuan_complete, .interactive_complete, or .simready_complete

main:
  params: [event]
  steps:
    - log_event:
        call: sys.log
        args:
          text: ${event}
          severity: "INFO"
        next: extract

    - extract:
        assign:
          - bucket: ${event.data.bucket}
          - object: ${event.data.name}
          - projectId: '${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}'
          - region: "us-central1"
        next: filter_completion_markers

    - filter_completion_markers:
        switch:
          - condition: '${text.match_regex(object, "^scenes/.+/assets/\\.(?:hunyuan|interactive|simready)_complete$")}'
            next: derive
        next: skip

    - derive:
        assign:
          - parts: '${text.split(object, "/")}'
          - sceneId: ${parts[1]}
          - layoutPrefix: '${"scenes/" + sceneId + "/layout"}'
          - assetsPrefix: '${"scenes/" + sceneId + "/assets"}'
          - usdPrefix: '${"scenes/" + sceneId + "/usd"}'
          - usdJobName: "usd-assembly-job"
          - hunyuanMarker: '${assetsPrefix + "/.hunyuan_complete"}'
          - interactiveMarker: '${assetsPrefix + "/.interactive_complete"}'
          - simreadyMarker: '${assetsPrefix + "/.simready_complete"}'
        next: log_start

    - log_start:
        call: sys.log
        args:
          text: '${"USD assembly triggered for scene " + sceneId + " - checking for all completion markers (hunyuan, interactive, simready)"}'
          severity: "INFO"
        next: check_hunyuan_marker

    - check_hunyuan_marker:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${hunyuanMarker}
          result: hunyuanExists
        except:
          as: e
          steps:
            - log_waiting:
                call: sys.log
                args:
                  text: '${"Waiting for hunyuan completion marker for scene " + sceneId}'
                  severity: "INFO"
                next: skip_not_ready
        next: check_interactive_marker

    - check_interactive_marker:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${interactiveMarker}
          result: interactiveExists
        except:
          as: e
          steps:
            - log_waiting_interactive:
                call: sys.log
                args:
                  text: '${"Waiting for interactive completion marker for scene " + sceneId}'
                  severity: "INFO"
                next: skip_not_ready
        next: check_simready_marker

    - check_simready_marker:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${simreadyMarker}
          result: simreadyExists
        except:
          as: e
          steps:
            - log_waiting_simready:
                call: sys.log
                args:
                  text: '${"Waiting for simready completion marker for scene " + sceneId}'
                  severity: "INFO"
                next: skip_not_ready
        next: log_all_ready

    - log_all_ready:
        call: sys.log
        args:
          text: '${"All asset jobs complete (hunyuan, interactive, simready) for scene " + sceneId + " - proceeding with USD assembly"}'
          severity: "INFO"
        next: run_usd_job

    - run_usd_job:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: '${"projects/" + projectId + "/locations/" + region + "/jobs/" + usdJobName}'
          body:
            overrides:
              containerOverrides:
                - env:
                    - name: BUCKET
                      value: ${bucket}
                    - name: SCENE_ID
                      value: ${sceneId}
                    - name: LAYOUT_PREFIX
                      value: ${layoutPrefix}
                    - name: ASSETS_PREFIX
                      value: ${assetsPrefix}
                    - name: USD_PREFIX
                      value: ${usdPrefix}
        result: usdExec
        next: wait_for_usd

    - wait_for_usd:
        call: googleapis.run.v2.projects.locations.jobs.executions.get
        args:
          name: ${usdExec.name}
        result: usdStatus
        next: check_usd_status

    - check_usd_status:
        switch:
          - condition: ${usdStatus.completionTime != null}
            next: log_usd_complete
          - condition: ${usdStatus.failedCount != null and usdStatus.failedCount > 0}
            next: usd_failed
        next: wait_usd_poll

    - wait_usd_poll:
        call: sys.sleep
        args:
          seconds: 10
        next: wait_for_usd

    - log_usd_complete:
        call: sys.log
        args:
          text: '${"USD assembly completed for scene " + sceneId}'
          severity: "INFO"
        next: done

    - usd_failed:
        assign:
          - errorMsg: '${"USD assembly job FAILED for scene " + sceneId}'
        next: log_usd_error

    - log_usd_error:
        call: sys.log
        args:
          text: ${errorMsg}
          severity: "ERROR"
        next: raise_usd_error

    - raise_usd_error:
        raise: ${errorMsg}

    - done:
        return:
          status: "SUCCESS"
          scene_id: ${sceneId}
          message: '${"USD assembly completed successfully for scene " + sceneId}'
          usd_execution: ${usdExec.name}

    - skip_not_ready:
        return:
          status: "WAITING"
          scene_id: ${sceneId}
          message: '${"Waiting for all asset generation jobs (hunyuan, interactive, simready) to complete for scene " + sceneId}'

    - skip:
        return:
          status: "SKIPPED"
          message: '${"Not a completion marker file: " + object}'