# Pipeline retention cleanup workflow
# Expected schedule: daily via Cloud Scheduler.

main:
  params: [event]
  steps:
    - init:
        assign:
          - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - region: "us-central1"
          - bucket: ${default(event.bucket, sys.get_env("GCS_BUCKET", "blueprintpipeline-data"))}
          - jobName: "retention-cleanup-job"
          - retentionDays: ${default(event.retention_days, sys.get_env("PIPELINE_RETENTION_DAYS", "30"))}
          - dryRun: ${default(event.dry_run, sys.get_env("PIPELINE_RETENTION_DRY_RUN", "false"))}
        next: log_start

    - log_start:
        call: sys.log
        args:
          data:
            bp_metric: "maintenance_job"
            event: "start"
            workflow: "retention-cleanup"
            job: ${jobName}
            bucket: ${bucket}
            retention_days: ${retentionDays}
            dry_run: ${dryRun}
            start_time: ${time.format(sys.now())}
          severity: "INFO"
        next: run_cleanup_job

    - run_cleanup_job:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: ${"projects/" + projectId + "/locations/" + region + "/jobs/" + jobName}
          body:
            overrides:
              containerOverrides:
                - env:
                    - name: PIPELINE_STORAGE_ROOT
                      value: "/mnt/gcs"
                    - name: GCS_BUCKET
                      value: ${bucket}
                    - name: PIPELINE_RETENTION_DAYS
                      value: ${retentionDays}
                    - name: PIPELINE_RETENTION_DRY_RUN
                      value: ${dryRun}
        result: cleanupExec
        next: log_complete

    - log_complete:
        call: sys.log
        args:
          data:
            bp_metric: "maintenance_job"
            event: "complete"
            workflow: "retention-cleanup"
            job: ${jobName}
            bucket: ${bucket}
            retention_days: ${retentionDays}
            dry_run: ${dryRun}
            end_time: ${time.format(sys.now())}
          severity: "INFO"
        next: done

    - done:
        return: ${"Retention cleanup triggered for bucket " + bucket}
