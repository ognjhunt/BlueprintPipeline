# =============================================================================
# Genie Sim Import Poller (Fallback)
# =============================================================================
#
# Scheduled workflow to discover completed Genie Sim jobs and trigger imports
# when direct triggers are not available.
#
# Expected schedule: every 5-10 minutes via Cloud Scheduler.
#
# Flow:
#   1. List job.json files under scenes/*/geniesim
#   2. For each completed job without an import marker, trigger import workflow
#

main:
  params: [event]
  steps:
    - init:
        assign:
          - project_id: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - region: ${default(sys.get_env("WORKFLOW_REGION"), "us-central1")}
          - bucket: ${default(event.bucket, sys.get_env("GCS_BUCKET", "blueprintpipeline-data"))}
          - import_workflow: "genie-sim-import-pipeline"
          - page_token: null
    - list_objects:
        call: googleapis.storage.v1.objects.list
        args:
          bucket: ${bucket}
          prefix: "scenes/"
          pageToken: ${page_token}
        result: list_result
        next: scan_objects

    - scan_objects:
        for:
          value: object
          in: ${default(list_result.items, [])}
          steps:
            - check_job_json:
                switch:
                  - condition: ${text.match_regex(object.name, "^scenes/.+/geniesim/job.json$")}
                    next: read_job_metadata
                next: continue

            - read_job_metadata:
                try:
                  call: googleapis.storage.v1.objects.get
                  args:
                    bucket: ${bucket}
                    object: ${object.name}
                    alt: "media"
                  result: job_metadata_raw
                except:
                  as: e
                  steps:
                    - log_read_error:
                        call: sys.log
                        args:
                          text: ${"Failed to read job metadata " + object.name + ": " + e.message}
                          severity: "WARNING"
                    - continue_after_read_error:
                        next: continue
                next: parse_job_metadata

            - parse_job_metadata:
                assign:
                  - job_metadata: ${json.decode(job_metadata_raw)}
                  - job_id: ${job_metadata.job_id}
                  - job_status: ${default(job_metadata.status, "unknown")}
                  - scene_id: ${default(job_metadata.scene_id, text.split(object.name, "/")[1])}
                next: check_completed

            - check_completed:
                switch:
                  - condition: ${job_id == null or job_id == ""}
                    next: continue
                  - condition: ${job_status != "completed"}
                    next: continue
                next: check_import_marker

            - check_import_marker:
                try:
                  call: googleapis.storage.v1.objects.get
                  args:
                    bucket: ${bucket}
                    object: ${"scenes/" + scene_id + "/geniesim/.geniesim_import_complete"}
                  result: marker_exists
                except:
                  as: e
                  steps:
                    - marker_missing:
                        switch:
                          - condition: ${e.code == 404}
                            next: trigger_import
                        next: continue
                next: continue

            - trigger_import:
                call: googleapis.workflowexecutions.v1.projects.locations.workflows.executions.create
                args:
                  parent: ${"projects/" + project_id + "/locations/" + region + "/workflows/" + import_workflow}
                  body:
                    argument: ${json.encode({"job_id": job_id, "scene_id": scene_id, "status": job_status})}
                result: import_execution
                next: log_triggered

            - log_triggered:
                call: sys.log
                args:
                  text: ${"Triggered import workflow for job " + job_id + " (scene: " + scene_id + ")"}
                  severity: "INFO"

    - check_next_page:
        switch:
          - condition: ${list_result.nextPageToken != null and list_result.nextPageToken != ""}
            next: set_next_page
        next: done

    - set_next_page:
        assign:
          - page_token: ${list_result.nextPageToken}
        next: list_objects

    - done:
        return:
          status: "ok"
          bucket: ${bucket}
