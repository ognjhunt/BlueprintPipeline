main:
  params: [event]
  steps:
    # 1) Log event (handy while debugging)
    - log_event:
        call: sys.log
        args:
          text: ${event}
          severity: "INFO"
        next: extract

    # 2) Extract fields we care about
    - extract:
        assign:
          - bucket: ${event.data.bucket}
          - object: ${event.data.name}
          - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - region: "us-central1"
        next: filter_dataset_yaml

    # 3) Only continue if object is scenes/<sceneId>/seg/dataset/data.yaml
    - filter_dataset_yaml:
        switch:
          - condition: ${text.match_regex(object, "(?i)^scenes/.+/seg/dataset/data\\.yaml$")}
            next: derive
        next: skip

    # 4) Derive sceneId, datasetPrefix, outPrefix
    #    object: scenes/<sceneId>/seg/dataset/data.yaml
    - derive:
        assign:
          - parts: ${text.split(object, "/")}
          - sceneId: ${parts[1]}
          - datasetPrefix: ${"scenes/" + sceneId + "/seg/dataset"}
          - outPrefix: ${"scenes/" + sceneId + "/da3"}
          - da3Geom: ${"scenes/" + sceneId + "/da3/da3_geom.npz"}
          - layoutPrefix: ${"scenes/" + sceneId + "/layout"}
          - jobName: "scene-da3-job"
          - da3Attempts: 0
        next: run_da3_job

    # 5) Invoke Cloud Run job scene-da3-job with env overrides
    - run_da3_job:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: ${"projects/" + projectId + "/locations/" + region + "/jobs/" + jobName}
          body:
            overrides:
              containerOverrides:
                - env:
                    - name: BUCKET
                      value: ${bucket}
                    - name: SCENE_ID
                      value: ${sceneId}
                    - name: DATASET_PREFIX
                      value: ${datasetPrefix}
                    - name: OUT_PREFIX
                      value: ${outPrefix}
        result: da3Exec
        next: wait_for_da3_geom

    # 6) Wait for da3_geom.npz completion marker
    - wait_for_da3_geom:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${da3Geom}
          result: da3Obj
        except:
          as: e
          steps:
            - handle_da3_error:
                next: retry_da3_geom
        next: log_before_layout

    - retry_da3_geom:
        switch:
          - condition: ${da3Attempts < 90}
            next: bump_da3_attempt
        next: fail_da3_geom

    - bump_da3_attempt:
        assign:
          - da3Attempts: ${da3Attempts + 1}
        next: sleep_da3_geom

    - sleep_da3_geom:
        call: sys.sleep
        args:
          seconds: 10
        next: wait_for_da3_geom

    - fail_da3_geom:
        raise: ${"da3_geom.npz not found after 15 minutes at " + da3Geom}

    # 7) Log before running layout-job
    - log_before_layout:
        call: sys.log
        args:
          text: ${"da3_geom.npz found, now triggering layout-job for scene " + sceneId}
          severity: "INFO"
        next: run_layout_job

    # 8) Run layout-job to generate scene_layout.json with OBB data
    - run_layout_job:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: ${"projects/" + projectId + "/locations/" + region + "/jobs/layout-job"}
          body:
            overrides:
              containerOverrides:
                - env:
                    - name: BUCKET
                      value: ${bucket}
                    - name: SCENE_ID
                      value: ${sceneId}
                    - name: DA3_PREFIX
                      value: ${outPrefix}
                    - name: SEG_DATASET_PREFIX
                      value: ${datasetPrefix}
                    - name: LAYOUT_PREFIX
                      value: ${layoutPrefix}
        result: layoutExec
        next: done

    # 9) Return success status
    - done:
        return: ${"scene-da3 and layout-job started for " + object}

    # 10) Skip non-matching objects
    - skip:
        return: ${"scene-da3 skip " + object}
