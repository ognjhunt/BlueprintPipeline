# genie-sim-export-pipeline.yaml
#
# Google Cloud Workflows pipeline that:
#   1. Triggers on completion marker file from variation-assets-pipeline (.variation_pipeline_complete)
#   2. Runs genie-sim-export-job to convert scene to Genie Sim 3.0 format
#   3. Writes .geniesim_complete marker when finished
#
# This pipeline replaces episode-generation-pipeline and isaac-lab-job when
# USE_GENIESIM=true (default). Genie Sim handles:
#   - LLM-based task generation
#   - cuRobo trajectory planning
#   - Automated/teleop data collection
#   - VLM evaluation
#   - LeRobot v0.3.3 export
#
# IMPORTANT: Only uses YOUR assets (FILTER_COMMERCIAL=true by default)
# to ensure commercial rights to generated data.
#
# COMMERCIAL USE REQUIREMENT:
#   This pipeline triggers AFTER variation-assets-pipeline completes, ensuring
#   that YOUR OWN generated assets are ready before export. Genie Sim's built-in
#   assets are CC BY-NC-SA 4.0 (non-commercial) and cannot be used for selling data.
#
# Pipeline Order:
#   replicator-job → variation-assets-pipeline → [THIS PIPELINE] → Genie Sim
#
# Trigger: Cloud Storage object finalized event for .variation_pipeline_complete
#
# EventArc Setup:
#   gcloud eventarc triggers create genie-sim-export-trigger \
#     --location=us-central1 \
#     --service-account="${WORKFLOW_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
#     --destination-workflow=genie-sim-export-pipeline \
#     --destination-workflow-location=us-central1 \
#     --event-filters="type=google.cloud.storage.object.v1.finalized" \
#     --event-filters="bucket=${BUCKET}" \
#     --event-data-content-type="application/json"
#
# Or run manually:
#   gcloud workflows run genie-sim-export-pipeline \
#     --location=us-central1 \
#     --data='{"data":{"bucket":"your-bucket","name":"scenes/kitchen_001/variation_assets/.variation_pipeline_complete"}}'

main:
  params: [event]
  steps:
    - log_event:
        call: sys.log
        args:
          text: '${event}'
          severity: "INFO"
        next: extract

    - extract:
        assign:
          - bucket: ${event.data.bucket}
          - object: ${event.data.name}
          - projectId: '${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}'
          - region: "us-central1"
          # Default to commercial-only assets (your own assets, not GenieSimAssets)
          - filterCommercial: true
          # Robot type (franka, g2, ur10)
          - robotType: '${default(map.get(event, "robot_type"), "franka")}'
          # Max tasks to generate hints for
          - maxTasks: '${default(map.get(event, "max_tasks"), "50")}'
        next: filter_completion_markers

    # Filter for .variation_pipeline_complete marker files
    # This ensures variation assets (YOUR assets) are ready before Genie Sim export
    - filter_completion_markers:
        switch:
          - condition: '${text.match_regex(object, "^scenes/.+/variation_assets/\\.variation_pipeline_complete$")}'
            next: derive
        next: skip

    - derive:
        assign:
          - parts: '${text.split(object, "/")}'
          - sceneId: ${parts[1]}
          - assetsPrefix: '${"scenes/" + sceneId + "/assets"}'
          - usdPrefix: '${"scenes/" + sceneId + "/usd"}'
          - variationAssetsPrefix: '${"scenes/" + sceneId + "/variation_assets"}'
          - replicatorPrefix: '${"scenes/" + sceneId + "/replicator"}'
          - geniesimPrefix: '${"scenes/" + sceneId + "/geniesim"}'
          - geniesimJobName: "genie-sim-export-job"
          - geniesimCompleteMarker: '${"scenes/" + sceneId + "/geniesim/.geniesim_complete"}'
        next: check_geniesim_enabled

    # Check if Genie Sim mode is enabled (can be overridden per-scene)
    - check_geniesim_enabled:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: '${"scenes/" + sceneId + "/config.json"}'
            alt: "media"
          result: sceneConfigRaw
        except:
          as: e
          steps:
            - log_no_config:
                call: sys.log
                args:
                  text: '${"No scene config found for " + sceneId + ", using Genie Sim mode (default)"}'
                  severity: "INFO"
                next: check_already_processed
        next: parse_scene_config

    - parse_scene_config:
        try:
          assign:
            - sceneConfig: ${json.decode(sceneConfigRaw)}
            # Check if USE_GENIESIM is explicitly disabled for this scene
            - useGeniesim: '${default(map.get(sceneConfig, "use_geniesim"), true)}'
            # Get robot type from config if specified
            - robotType: '${default(map.get(sceneConfig, "robot_type"), robotType)}'
        except:
          as: e
          steps:
            - log_parse_error:
                call: sys.log
                args:
                  text: '${"Error parsing scene config: " + e.message}'
                  severity: "WARNING"
        next: check_geniesim_switch

    - check_geniesim_switch:
        switch:
          - condition: '${useGeniesim == false}'
            next: skip_geniesim_disabled
        next: check_already_processed

    - skip_geniesim_disabled:
        call: sys.log
        args:
          text: '${"Genie Sim disabled for scene " + sceneId + " (use_geniesim=false in config)"}'
          severity: "INFO"
        next: skip

    # Check if already processed (idempotence)
    - check_already_processed:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${geniesimCompleteMarker}
          result: existingMarker
        except:
          as: e
          steps:
            - check_not_found:
                switch:
                  - condition: '${e.code == 404}'
                    next: log_start
                next: raise_check_error
        next: skip_already_processed

    - skip_already_processed:
        call: sys.log
        args:
          text: '${"Genie Sim export already completed for scene " + sceneId + " - skipping"}'
          severity: "INFO"
        next: skip

    - raise_check_error:
        raise: '${e}'

    - log_start:
        call: sys.log
        args:
          text: '${"Genie Sim export triggered for scene " + sceneId + " (robot: " + robotType + ", commercial_only: " + string(filterCommercial) + ")"}'
          severity: "INFO"
        next: run_geniesim_job

    # Run the Genie Sim export job
    # NOTE: This job uses YOUR variation assets (from variation-gen-job), NOT Genie Sim's assets
    - run_geniesim_job:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: '${"projects/" + projectId + "/locations/" + region + "/jobs/" + geniesimJobName}'
          body:
            overrides:
              containerOverrides:
                - env:
                    - name: BUCKET
                      value: ${bucket}
                    - name: SCENE_ID
                      value: ${sceneId}
                    - name: ASSETS_PREFIX
                      value: ${assetsPrefix}
                    - name: GENIESIM_PREFIX
                      value: ${geniesimPrefix}
                    - name: VARIATION_ASSETS_PREFIX
                      value: ${variationAssetsPrefix}
                    - name: REPLICATOR_PREFIX
                      value: ${replicatorPrefix}
                    - name: ROBOT_TYPE
                      value: ${robotType}
                    - name: MAX_TASKS
                      value: ${maxTasks}
                    - name: FILTER_COMMERCIAL
                      value: "true"
                    - name: COPY_USD
                      value: "true"
                    # Enable all enhanced features for commercial data generation
                    - name: ENABLE_MULTI_ROBOT
                      value: "true"
                    - name: ENABLE_VLA_PACKAGES
                      value: "true"
        result: geniesimExec
        next: set_execution_name

    - set_execution_name:
        assign:
          - executionName: '${if(geniesimExec.metadata != null and geniesimExec.metadata.name != null, geniesimExec.metadata.name, geniesimExec.name)}'
        next: wait_for_job

    - wait_for_job:
        call: googleapis.run.v2.projects.locations.jobs.executions.get
        args:
          name: ${executionName}
        result: jobStatus
        next: check_job_status

    - check_job_status:
        assign:
          - jobState: '${if(jobStatus.state != null, jobStatus.state, if(jobStatus.status != null, jobStatus.status.state, null))}'
          - jobFailedCount: '${if(jobStatus.failedCount != null, jobStatus.failedCount, if(jobStatus.status != null, jobStatus.status.failedCount, null))}'
          - jobSucceededCount: '${if(jobStatus.succeededCount != null, jobStatus.succeededCount, if(jobStatus.status != null, jobStatus.status.succeededCount, null))}'
        next: job_status_switch

    - job_status_switch:
        switch:
          - condition: '${jobState == "FAILED" or (jobFailedCount != null and jobFailedCount > 0)}'
            next: job_failed
          - condition: '${jobState == "SUCCEEDED" or (jobSucceededCount != null and jobSucceededCount > 0)}'
            next: log_job_complete
        next: wait_poll

    - wait_poll:
        call: sys.sleep
        args:
          seconds: 10
        next: wait_for_job

    - log_job_complete:
        call: sys.log
        args:
          text: '${"Genie Sim export completed for scene " + sceneId}'
          severity: "INFO"
        next: write_completion_marker

    # Write completion marker
    - write_completion_marker:
        call: googleapis.storage.v1.objects.insert
        args:
          bucket: ${bucket}
          name: ${geniesimCompleteMarker}
          uploadType: "media"
          body: '${"{\"scene_id\": \"" + sceneId + "\", \"status\": \"completed\", \"timestamp\": \"" + time.format(sys.now()) + "\", \"robot_type\": \"" + robotType + "\", \"commercial_only\": true, \"ready_for_geniesim\": true}"}'
        result: markerResult
        next: done

    - job_failed:
        call: sys.log
        args:
          text: '${"ERROR: Genie Sim export failed for scene " + sceneId}'
          severity: "ERROR"
        next: write_failure_marker

    - write_failure_marker:
        call: googleapis.storage.v1.objects.insert
        args:
          bucket: ${bucket}
          name: '${"scenes/" + sceneId + "/geniesim/.geniesim_failed"}'
          uploadType: "media"
          body: '${"{\"scene_id\": \"" + sceneId + "\", \"status\": \"failed\", \"timestamp\": \"" + time.format(sys.now()) + "\"}"}'
        result: failMarkerResult
        next: done_with_failure

    # =========================================================================
    # Completion
    # =========================================================================

    - done:
        return:
          status: "SUCCESS"
          scene_id: ${sceneId}
          message: '${"Genie Sim export completed for scene " + sceneId}'
          execution: ${geniesimExec.name}
          outputs:
            scene_graph: '${"scenes/" + sceneId + "/geniesim/scene_graph.json"}'
            asset_index: '${"scenes/" + sceneId + "/geniesim/asset_index.json"}'
            task_config: '${"scenes/" + sceneId + "/geniesim/task_config.json"}'
            scene_config: '${"scenes/" + sceneId + "/geniesim/scene_config.yaml"}'
          next_steps:
            - "Run Genie Sim data collection on your infrastructure"
            - "Episodes will be generated in LeRobot v0.3.3 format"
            - "VLM evaluation included with 100k+ scenarios"

    - done_with_failure:
        return:
          status: "FAILED"
          scene_id: ${sceneId}
          message: '${"Genie Sim export failed for scene " + sceneId}'

    - skip:
        return:
          status: "SKIPPED"
          message: '${"Not a replicator completion marker file or Genie Sim disabled: " + object}'
