# genie-sim-export-pipeline.yaml
#
# Google Cloud Workflows pipeline that:
#   1. Triggers on completion marker file from variation-gen-job (.variation_pipeline_complete)
#   2. Runs genie-sim-export-job to convert scene to Genie Sim 3.0 format
#   3. Writes .geniesim_submitted marker after submission (non-complete states)
#   4. Writes .geniesim_complete marker after job completion (and local import)
#   4. Triggers arena-export-pipeline for policy evaluation infrastructure
#
# This pipeline replaces episode-generation-pipeline and isaac-lab-job when
# USE_GENIESIM=true (default). Genie Sim handles:
#   - LLM-based task generation
#   - cuRobo trajectory planning
#   - Automated/teleop data collection
#   - VLM evaluation
#   - LeRobot v0.3.3 export
#
# ARENA INTEGRATION:
#   After .geniesim_complete is written, arena-export-pipeline automatically triggers.
#   .geniesim_submitted does NOT trigger Arena.
#   This ensures you have BOTH:
#     - Training DATA (episodes from Genie Sim)
#     - Evaluation INFRASTRUCTURE (Arena benchmarks) to test trained policies
#
# IMPORTANT: Only uses YOUR assets (FILTER_COMMERCIAL=true by default)
# to ensure commercial rights to generated data.
#
# COMMERCIAL USE REQUIREMENT:
#   This pipeline triggers AFTER variation-gen-job completes, ensuring
#   that YOUR OWN generated assets are ready before export. Genie Sim's built-in
#   assets are CC BY-NC-SA 4.0 (non-commercial) and cannot be used for selling data.
#
# Pipeline Order:
#   replicator-job → variation-gen-job → [THIS PIPELINE] → Genie Sim
#                                                 ↓
#                                        arena-export-pipeline (automatic)
#
# Trigger: Cloud Storage object finalized event for .variation_pipeline_complete
#
# EventArc Setup:
#   gcloud eventarc triggers create genie-sim-export-trigger \
#     --location=us-central1 \
#     --service-account="${WORKFLOW_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
#     --destination-workflow=genie-sim-export-pipeline \
#     --destination-workflow-location=us-central1 \
#     --event-filters="type=google.cloud.storage.object.v1.finalized" \
#     --event-filters="bucket=${BUCKET}" \
#     --event-data-content-type="application/json"
#
# Or run manually:
#   gcloud workflows run genie-sim-export-pipeline \
#     --location=us-central1 \
#     --data='{"data":{"bucket":"your-bucket","name":"scenes/kitchen_001/variation_assets/.variation_pipeline_complete"}}'

main:
  params: [event]
  steps:
    - log_event:
        call: sys.log
        args:
          text: '${event}'
          severity: "INFO"
        next: extract

    - extract:
        assign:
          - bucket: ${event.data.bucket}
          - object: ${event.data.name}
          - projectId: '${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}'
          - primaryRegion: ${default(sys.get_env("PRIMARY_WORKFLOW_REGION"), "us-central1")}
          - secondaryRegion: ${default(sys.get_env("SECONDARY_WORKFLOW_REGION"), "us-east1")}
          - region: ${primaryRegion}
          - workflowName: "genie-sim-export-pipeline"
          - geniesimExportTimeoutSeconds: 2700
          - geniesimSubmissionTimeoutSeconds: 14400
          - geniesimGenerationSlaSeconds: 14400
          # Default to commercial-only assets (your own assets, not GenieSimAssets)
          - filterCommercial: true
          # Robot type (franka, g2, ur10)
          - robotType: '${default(map.get(event, "robot_type"), "franka")}'
          # Max tasks to generate hints for
          - maxTasks: '${default(map.get(event, "max_tasks"), "50")}'
          - gkeCluster: '${default(map.get(event, "gke_cluster"), "blueprint-cluster")}'
          - gkeZone: '${default(map.get(event, "gke_zone"), "us-central1-a")}'
          - gkeNamespace: '${default(map.get(event, "gke_namespace"), "blueprint")}'
          - gkeGpuAccelerator: '${default(map.get(event, "gke_gpu_accelerator"), "nvidia-tesla-t4")}'
          - gkeServiceAccount: '${default(map.get(event, "gke_service_account"), "blueprint-pipeline-sa")}'
          - canaryEnabled: '${default(map.get(event, "canary_enabled"), false)}'
          - canaryTags: '${default(map.get(event, "canary_tags"), default(sys.get_env("CANARY_TAGS"), ""))}'
          - canarySceneIds: '${default(map.get(event, "canary_scene_ids"), "")}'
          - canaryPercent: '${default(map.get(event, "canary_percent"), default(sys.get_env("CANARY_PERCENT"), "0"))}'
          - canaryReleaseChannel: '${default(map.get(event, "canary_release_channel"), default(sys.get_env("CANARY_RELEASE_CHANNEL"), "stable"))}'
          - firebaseBucket: '${default(sys.get_env("FIREBASE_STORAGE_BUCKET"), "")}'
          - firebaseServiceAccountJson: '${default(sys.get_env("FIREBASE_SERVICE_ACCOUNT_JSON"), "")}'
          - firebaseServiceAccountPath: '${default(sys.get_env("FIREBASE_SERVICE_ACCOUNT_PATH"), "/secrets/firebase/service-account.json")}'
          - firebaseUploadPrefix: '${default(sys.get_env("FIREBASE_UPLOAD_PREFIX"), "datasets")}'
          - stableImageTag: '${default(sys.get_env("GENIESIM_IMAGE_TAG"), "isaacsim")}'
          - canaryImageTag: '${default(map.get(event, "canary_image_tag"), default(sys.get_env("GENIESIM_CANARY_IMAGE_TAG"), "isaacsim-canary"))}'
          - geniesimImageTag: ${if(canaryEnabled, canaryImageTag, stableImageTag)}
          - canaryRollbackMarker: '${default(map.get(event, "canary_rollback_marker"), "")}'
        next: filter_completion_markers

    # Filter for .variation_pipeline_complete marker files
    # This ensures variation assets (YOUR assets) are ready before Genie Sim export
    - filter_completion_markers:
        switch:
          - condition: '${text.match_regex(object, "^scenes/.+/variation_assets/\\.variation_pipeline_complete$")}'
            next: derive
        next: skip

    - derive:
        assign:
          - parts: '${text.split(object, "/")}'
          - sceneId: ${parts[1]}
          - assetsPrefix: '${"scenes/" + sceneId + "/assets"}'
          - usdPrefix: '${"scenes/" + sceneId + "/usd"}'
          - variationAssetsPrefix: '${"scenes/" + sceneId + "/variation_assets"}'
          - replicatorPrefix: '${"scenes/" + sceneId + "/replicator"}'
          - geniesimPrefix: '${"scenes/" + sceneId + "/geniesim"}'
          - geniesimJobName: "genie-sim-export-job"
          - geniesimSubmitJobName: "genie-sim-submit-job"
          - geniesimGpuJobName: "genie-sim-gpu-job"
          - geniesimCompleteMarker: '${"scenes/" + sceneId + "/geniesim/.geniesim_complete"}'
          - geniesimSubmittedMarker: '${"scenes/" + sceneId + "/geniesim/.geniesim_submitted"}'
          - geniesimImportCompleteMarker: '${"scenes/" + sceneId + "/geniesim/.geniesim_import_complete"}'
          - geniesimJobMetadataPath: '${"scenes/" + sceneId + "/geniesim/job.json"}'
          - geniesimFailedMarker: '${"scenes/" + sceneId + "/geniesim/.failed"}'
          - geniesimLegacyFailedMarker: '${"scenes/" + sceneId + "/geniesim/.geniesim_failed"}'
          - canaryRollbackObject: ${if(canaryRollbackMarker == "", geniesimPrefix + "/.canary_rollback", canaryRollbackMarker)}
        next: check_rollback_marker

    - check_rollback_marker:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${canaryRollbackObject}
        next: rollback_marker_found
        except:
          as: rollbackError
          steps:
            - rollback_marker_not_found:
                switch:
                  - condition: ${rollbackError.code == 404}
                    next: init_region_health
                next: log_rollback_marker_error
            - log_rollback_marker_error:
                call: sys.log
                args:
                  text: '${"Unable to check rollback marker " + canaryRollbackObject + ": " + rollbackError.message}'
                  severity: "WARNING"
                next: init_region_health

    - rollback_marker_found:
        call: sys.log
        args:
          text: '${"Rollback marker present at " + canaryRollbackObject + ". Skipping Genie Sim export."}'
          severity: "ERROR"
        next: stop_for_rollback

    - stop_for_rollback:
        return: ${"Rollback marker present at " + canaryRollbackObject + ". Skipping Genie Sim export."}

    - init_region_health:
        assign:
          - primaryHealthy: false
          - secondaryHealthy: false
        next: check_primary_region

    - check_primary_region:
        try:
          call: googleapis.run.v1.projects.locations.jobs.get
          args:
            name: '${"projects/" + projectId + "/locations/" + primaryRegion + "/jobs/" + geniesimJobName}'
          result: primaryJob
        next: mark_primary_healthy
        except:
          as: primaryError
          steps:
            - log_primary_unhealthy:
                call: sys.log
                args:
                  text: '${"Primary region " + primaryRegion + " job " + geniesimJobName + " unavailable: " + primaryError.message}'
                  severity: "WARNING"
            - check_secondary_region:
                try:
                  call: googleapis.run.v1.projects.locations.jobs.get
                  args:
                    name: '${"projects/" + projectId + "/locations/" + secondaryRegion + "/jobs/" + geniesimJobName}'
                  result: secondaryJob
                next: mark_secondary_healthy
                except:
                  as: secondaryError
                  steps:
                    - log_secondary_unhealthy:
                        call: sys.log
                        args:
                          text: '${"Secondary region " + secondaryRegion + " job " + geniesimJobName + " unavailable: " + secondaryError.message}'
                          severity: "ERROR"
                    - select_region

    - mark_primary_healthy:
        assign:
          - primaryHealthy: true
        next: select_region

    - mark_secondary_healthy:
        assign:
          - secondaryHealthy: true
        next: select_region

    - select_region:
        switch:
          - condition: ${primaryHealthy}
            next: use_primary_region
          - condition: ${secondaryHealthy}
            next: use_secondary_region
        next: use_primary_region

    - use_primary_region:
        assign:
          - region: ${primaryRegion}
        next: check_geniesim_enabled

    - use_secondary_region:
        assign:
          - region: ${secondaryRegion}
        next: check_geniesim_enabled

    # Check if Genie Sim mode is enabled (can be overridden per-scene)
    - check_geniesim_enabled:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: '${"scenes/" + sceneId + "/config.json"}'
            alt: "media"
          result: sceneConfigRaw
        except:
          as: e
          steps:
            - log_no_config:
                call: sys.log
                args:
                  text: '${"No scene config found for " + sceneId + ", using Genie Sim mode (default)"}'
                  severity: "INFO"
                next: check_already_processed
        next: parse_scene_config

    - parse_scene_config:
        try:
          assign:
            - sceneConfig: ${json.decode(sceneConfigRaw)}
            # Check if USE_GENIESIM is explicitly disabled for this scene
            - useGeniesim: '${default(map.get(sceneConfig, "use_geniesim"), true)}'
            # Get robot type from config if specified
            - robotType: '${default(map.get(sceneConfig, "robot_type"), robotType)}'
        except:
          as: e
          steps:
            - log_parse_error:
                call: sys.log
                args:
                  text: '${"Error parsing scene config: " + e.message}'
                  severity: "WARNING"
        next: check_geniesim_switch

    - check_geniesim_switch:
        switch:
          - condition: '${useGeniesim == false}'
            next: skip_geniesim_disabled
        next: check_already_processed

    - skip_geniesim_disabled:
        call: sys.log
        args:
          text: '${"Genie Sim disabled for scene " + sceneId + " (use_geniesim=false in config)"}'
          severity: "INFO"
        next: skip

    # Check if already processed (idempotence)
    - check_already_processed:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${geniesimCompleteMarker}
          result: existingMarker
        except:
          as: e
          steps:
            - check_not_found:
                switch:
                  - condition: '${e.code == 404}'
                    next: log_start
                next: raise_check_error
        next: skip_already_processed

    - skip_already_processed:
        call: sys.log
        args:
          text: '${"Genie Sim export already completed for scene " + sceneId + " - skipping"}'
          severity: "INFO"
        next: skip

    - raise_check_error:
        raise: '${e}'

    - log_start:
        call: sys.log
        args:
          text: '${"Genie Sim export triggered for scene " + sceneId + " (robot: " + robotType + ", commercial_only: " + string(filterCommercial) + ")"}'
          severity: "INFO"
        next: init_export_metrics

    - init_export_metrics:
        assign:
          - exportStartTime: '${time.format(sys.now())}'
        next: emit_export_metrics_start

    - emit_export_metrics_start:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "start"
            workflow: ${workflowName}
            job: ${geniesimJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${geniesimExportTimeoutSeconds}
            retry_max: 5
            start_time: ${exportStartTime}
          severity: "INFO"
        next: run_geniesim_job

    # Run the Genie Sim export job
    # NOTE: This job uses YOUR variation assets (from variation-gen-job), NOT Genie Sim's assets
    # WITH RETRY: Exponential backoff for transient failures (max 5 retries, ~2min total backoff)
    - run_geniesim_job:
        try:
          call: googleapis.run.v2.projects.locations.jobs.run
          args:
            name: '${"projects/" + projectId + "/locations/" + region + "/jobs/" + geniesimJobName}'
            body:
              overrides:
                containerOverrides:
                  - env:
                      - name: BUCKET
                        value: ${bucket}
                      - name: SCENE_ID
                        value: ${sceneId}
                      - name: ASSETS_PREFIX
                        value: ${assetsPrefix}
                      - name: GENIESIM_PREFIX
                        value: ${geniesimPrefix}
                      - name: VARIATION_ASSETS_PREFIX
                        value: ${variationAssetsPrefix}
                      - name: REPLICATOR_PREFIX
                        value: ${replicatorPrefix}
                      - name: ROBOT_TYPE
                        value: ${robotType}
                      - name: MAX_TASKS
                        value: ${maxTasks}
                      - name: FILTER_COMMERCIAL
                        value: "true"
                      - name: COPY_USD
                        value: "true"
                      - name: REQUIRE_QUALITY_GATES
                        value: "true"
                      # Enable all enhanced features for commercial data generation
                      - name: ENABLE_MULTI_ROBOT
                        value: "true"
                      - name: ENABLE_VLA_PACKAGES
                        value: "true"
            timeout: '${string(geniesimExportTimeoutSeconds) + "s"}'
          result: geniesimExec
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 5
          backoff:
            initial_delay: 1
            max_delay: 60
            multiplier: 2
        except:
          as: e
          steps:
            - log_export_retry_exhausted:
                call: sys.log
                args:
                  data:
                    bp_metric: "job_retry_exhausted"
                    workflow: ${workflowName}
                    job: ${geniesimJobName}
                    scene_id: ${sceneId}
                    retry_max: 5
                    error: ${e.message}
                  severity: "ERROR"
            - list_geniesim_outputs_for_cleanup:
                call: googleapis.storage.v1.objects.list
                args:
                  bucket: ${bucket}
                  prefix: ${geniesimPrefix + "/"}
                  maxResults: 1000
                result: geniesimCleanupList
            - delete_geniesim_outputs_for_cleanup:
                for:
                  value: geniesimCleanupItem
                  in: ${default(geniesimCleanupList.items, [])}
                  steps:
                    - delete_geniesim_output:
                        call: googleapis.storage.v1.objects.delete
                        args:
                          bucket: ${bucket}
                          object: ${geniesimCleanupItem.name}
            - write_geniesim_failure_marker:
                call: googleapis.storage.v1.objects.insert
                args:
                  bucket: ${bucket}
                  name: ${geniesimFailedMarker}
                  uploadType: "media"
                  body: ${json.encode({
                    "scene_id": sceneId,
                    "job_name": geniesimJobName,
                    "status": "failed",
                    "timestamp": time.format(sys.now()),
                    "error": {
                      "code": "geniesim_export_start_failed",
                      "message": e.message,
                      "type": "workflow_failure",
                      "stack_trace": null
                    },
                    "context": {
                      "workflow_execution_id": sys.get_env("GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID"),
                      "attempt_number": 1,
                      "config_context": {
                        "geniesim_prefix": geniesimPrefix
                      }
                    }
                  })}
            - log_job_error:
                call: sys.log
                args:
                  text: '${"Failed to start Genie Sim job after retries: " + e.message}'
                  severity: "ERROR"
            - raise_job_error:
                raise: ${e}
        next: set_execution_name

    - set_execution_name:
        assign:
          - executionName: '${if(geniesimExec.metadata != null and geniesimExec.metadata.name != null, geniesimExec.metadata.name, geniesimExec.name)}'
        next: wait_for_job

    - wait_for_job:
        call: googleapis.run.v2.projects.locations.jobs.executions.get
        args:
          name: ${executionName}
        result: jobStatus
        next: check_job_status

    - check_job_status:
        assign:
          - jobState: '${if(jobStatus.state != null, jobStatus.state, if(jobStatus.status != null, jobStatus.status.state, null))}'
          - jobFailedCount: '${if(jobStatus.failedCount != null, jobStatus.failedCount, if(jobStatus.status != null, jobStatus.status.failedCount, null))}'
          - jobSucceededCount: '${if(jobStatus.succeededCount != null, jobStatus.succeededCount, if(jobStatus.status != null, jobStatus.status.succeededCount, null))}'
        next: job_status_switch

    - job_status_switch:
        switch:
          - condition: '${jobState == "FAILED" or (jobFailedCount != null and jobFailedCount > 0)}'
            next: job_failed
          - condition: '${jobState == "SUCCEEDED" or (jobSucceededCount != null and jobSucceededCount > 0)}'
            next: log_job_complete
        next: wait_poll

    - wait_poll:
        call: sys.sleep
        args:
          seconds: 10
        next: wait_for_job

    - log_job_complete:
        assign:
          - exportEndTime: '${time.format(sys.now())}'
          - exportDurationSeconds: '${time.parse(exportEndTime) - time.parse(exportStartTime)}'
          - exportTimeoutUsageRatio: '${exportDurationSeconds / geniesimExportTimeoutSeconds}'
          - exportTimedOut: '${exportDurationSeconds >= geniesimExportTimeoutSeconds}'
        next: emit_export_metrics_complete

    - emit_export_metrics_complete:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "complete"
            workflow: ${workflowName}
            job: ${geniesimJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${geniesimExportTimeoutSeconds}
            duration_seconds: ${exportDurationSeconds}
            timeout_usage_ratio: ${exportTimeoutUsageRatio}
            timed_out: ${exportTimedOut}
            status: "SUCCEEDED"
            execution_name: ${executionName}
            start_time: ${exportStartTime}
            end_time: ${exportEndTime}
          severity: "INFO"
        next: log_export_complete_message

    - log_export_complete_message:
        call: sys.log
        args:
          text: '${"Genie Sim export completed for scene " + sceneId}'
          severity: "INFO"
        next: ensure_asset_provenance_report

    - ensure_asset_provenance_report:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${geniesimPrefix + "/legal/asset_provenance.json"}
        except:
          as: e
          steps:
            - handle_missing_asset_provenance_report:
                switch:
                  - condition: '${e.code == 404}'
                    next: log_missing_asset_provenance_report
                next: raise_asset_provenance_report_error
            - log_missing_asset_provenance_report:
                call: sys.log
                args:
                  text: '${"Missing asset provenance report at gs://" + bucket + "/" + geniesimPrefix + "/legal/asset_provenance.json. Rerun the variation-gen legal report step before submitting."}'
                  severity: "ERROR"
                next: raise_asset_provenance_report_error
            - raise_asset_provenance_report_error:
                raise:
                  message: '${"Missing asset provenance report at gs://" + bucket + "/" + geniesimPrefix + "/legal/asset_provenance.json"}'
        next: init_submission_metrics

    - init_submission_metrics:
        assign:
          - submissionStartTime: '${time.format(sys.now())}'
          - submissionJobName: ${geniesimGpuJobName}
        next: emit_submission_metrics_start

    - emit_submission_metrics_start:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "start"
            workflow: ${workflowName}
            job: ${submissionJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${geniesimSubmissionTimeoutSeconds}
            retry_max: 3
            start_time: ${submissionStartTime}
          severity: "INFO"
        next: dispatch_submission_job

    - dispatch_submission_job:
        next: run_geniesim_gpu_job

    # Run local Genie Sim execution (GKE GPU job via Cloud Build)
    - run_geniesim_gpu_job:
        try:
          call: googleapis.cloudbuild.v1.projects.builds.create
          args:
            projectId: ${projectId}
            body:
              steps:
                - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
                  entrypoint: 'bash'
                  args:
                    - '-c'
                    - |
                      set -e

                      gcloud container clusters get-credentials ${gkeCluster} \
                        --zone=${gkeZone} \
                        --project=${projectId}

                      GPU_NODE_COUNT=$(kubectl get nodes \
                        -l cloud.google.com/gke-accelerator=${gkeGpuAccelerator} \
                        -o name | wc -l | tr -d ' ')
                      if [ "${GPU_NODE_COUNT}" -eq 0 ]; then
                        echo "ERROR: No GPU nodes found with accelerator label ${gkeGpuAccelerator}."
                        exit 1
                      fi

                      GPU_CAPACITY=$(kubectl get nodes \
                        -l cloud.google.com/gke-accelerator=${gkeGpuAccelerator} \
                        -o jsonpath='{range .items[*]}{.status.capacity.nvidia\.com/gpu}{"\n"}{end}' \
                        | awk 'BEGIN{sum=0} {if ($1 ~ /^[0-9]+$/) sum+=$1} END{print sum}')
                      if [ "${GPU_CAPACITY:-0}" -le 0 ]; then
                        echo "ERROR: GPU capacity is not reported on GPU nodes."
                        exit 1
                      fi

                      JOB_NAME="geniesim-gpu-${sceneId}-$(date +%s)"

                      cat <<EOFK8S | kubectl apply -f -
                      apiVersion: batch/v1
                      kind: Job
                      metadata:
                        name: ${JOB_NAME}
                        namespace: ${gkeNamespace}
                        labels:
                          app: blueprint-pipeline
                          component: genie-sim-gpu-local
                          scene-id: ${sceneId}
                      spec:
                        backoffLimit: 2
                        ttlSecondsAfterFinished: 3600
                        activeDeadlineSeconds: 14400
                        template:
                          metadata:
                            labels:
                              app: blueprint-pipeline
                              component: genie-sim-gpu-local
                          spec:
                            restartPolicy: OnFailure
                            serviceAccountName: ${gkeServiceAccount}
                            nodeSelector:
                              cloud.google.com/gke-accelerator: ${gkeGpuAccelerator}
                            tolerations:
                              - key: nvidia.com/gpu
                                operator: Exists
                                effect: NoSchedule
                            containers:
                              - name: genie-sim-local
                                image: gcr.io/${projectId}/blueprint-genie-sim:${geniesimImageTag}
                                imagePullPolicy: Always
                                env:
                                  - name: BUCKET
                                    value: ${bucket}
                                  - name: SCENE_ID
                                    value: ${sceneId}
                                  - name: GENIESIM_PREFIX
                                    value: ${geniesimPrefix}
                                  - name: JOB_OUTPUT_PATH
                                    value: ${geniesimJobMetadataPath}
                                  - name: ROBOT_TYPE
                                    value: ${robotType}
                                  - name: EPISODES_PER_TASK
                                    value: "10"
                                  - name: NUM_VARIATIONS
                                    value: "5"
                                  - name: OUTPUT_PREFIX
                                    value: ${"scenes/" + sceneId + "/episodes"}
                                  - name: GENIESIM_FORCE_LOCAL
                                    value: "true"
                                  - name: GENIESIM_HOST
                                    value: ${default(sys.get_env("GENIESIM_HOST"), "localhost")}
                                  - name: GENIESIM_PORT
                                    value: ${default(sys.get_env("GENIESIM_PORT"), "50051")}
                                  - name: GENIESIM_ROOT
                                    value: ${default(sys.get_env("GENIESIM_ROOT"), "/opt/geniesim")}
                                  - name: ISAAC_SIM_PATH
                                    value: ${default(sys.get_env("ISAAC_SIM_PATH"), "/isaac-sim")}
                                  - name: GOOGLE_APPLICATION_CREDENTIALS
                                    value: /secrets/gcs/key.json
                                  - name: CANARY_ENABLED
                                    value: '${if(canaryEnabled, "true", "false")}'
                                  - name: CANARY_TAGS
                                    value: ${canaryTags}
                                  - name: CANARY_SCENE_IDS
                                    value: ${canarySceneIds}
                                  - name: CANARY_PERCENT
                                    value: ${string(canaryPercent)}
                                  - name: CANARY_RELEASE_CHANNEL
                                    value: ${canaryReleaseChannel}
                                  - name: CANARY_ROLLBACK_MARKER
                                    value: ${if(canaryRollbackMarker == "", geniesimPrefix + "/.canary_rollback", canaryRollbackMarker)}
                                  - name: FIREBASE_STORAGE_BUCKET
                                    value: ${firebaseBucket}
                                  - name: FIREBASE_SERVICE_ACCOUNT_JSON
                                    value: ${firebaseServiceAccountJson}
                                  - name: FIREBASE_SERVICE_ACCOUNT_PATH
                                    value: ${firebaseServiceAccountPath}
                                  - name: FIREBASE_UPLOAD_PREFIX
                                    value: ${firebaseUploadPrefix}
                                resources:
                                  requests:
                                    cpu: "4"
                                    memory: "16Gi"
                                    nvidia.com/gpu: 1
                                  limits:
                                    cpu: "8"
                                    memory: "32Gi"
                                    nvidia.com/gpu: 1
                                volumeMounts:
                                  - name: gcs-credentials
                                    mountPath: /secrets/gcs
                                    readOnly: true
                                  - name: dshm
                                    mountPath: /dev/shm
                                  - name: isaac-cache
                                    mountPath: /root/.cache/ov
                            volumes:
                              - name: gcs-credentials
                                secret:
                                  secretName: gcs-service-account
                              - name: dshm
                                emptyDir:
                                  medium: Memory
                                  sizeLimit: 16Gi
                              - name: isaac-cache
                                emptyDir:
                                  sizeLimit: 50Gi
                      EOFK8S

                      echo "Created Kubernetes Job: ${JOB_NAME}"

                      while true; do
                        STATUS=$(kubectl get job ${JOB_NAME} -n ${gkeNamespace} -o jsonpath='{.status.conditions[?(@.type=="Complete")].status}' 2>/dev/null || echo "")
                        FAILED=$(kubectl get job ${JOB_NAME} -n ${gkeNamespace} -o jsonpath='{.status.conditions[?(@.type=="Failed")].status}' 2>/dev/null || echo "")

                        if [ "$STATUS" == "True" ]; then
                          echo "Job completed successfully!"
                          exit 0
                        elif [ "$FAILED" == "True" ]; then
                          echo "Job failed!"
                          kubectl logs job/${JOB_NAME} -n ${gkeNamespace} --tail=200 || true
                          exit 1
                        fi

                        echo "Job still running... ($(date))"
                        sleep 30
                      done
              timeout: '${string(geniesimSubmissionTimeoutSeconds) + "s"}'
              options:
                logging: CLOUD_LOGGING_ONLY
        result: geniesimGpuBuild
        retry:
          predicate: ${http.default_retry_predicate}
          max_retries: 3
          backoff:
            initial_delay: 2
            max_delay: 30
            multiplier: 2
        except:
          as: e
          steps:
            - log_local_submission_retry_exhausted:
                call: sys.log
                args:
                  data:
                    bp_metric: "job_retry_exhausted"
                    workflow: ${workflowName}
                    job: ${geniesimGpuJobName}
                    scene_id: ${sceneId}
                    retry_max: 3
                    error: ${e.message}
                  severity: "ERROR"
            - list_geniesim_gpu_outputs_for_cleanup:
                call: googleapis.storage.v1.objects.list
                args:
                  bucket: ${bucket}
                  prefix: ${geniesimPrefix + "/"}
                  maxResults: 1000
                result: geniesimGpuCleanupList
            - delete_geniesim_gpu_outputs_for_cleanup:
                for:
                  value: geniesimGpuCleanupItem
                  in: ${default(geniesimGpuCleanupList.items, [])}
                  steps:
                    - delete_geniesim_gpu_output:
                        call: googleapis.storage.v1.objects.delete
                        args:
                          bucket: ${bucket}
                          object: ${geniesimGpuCleanupItem.name}
            - write_geniesim_gpu_failure_marker:
                call: googleapis.storage.v1.objects.insert
                args:
                  bucket: ${bucket}
                  name: ${geniesimFailedMarker}
                  uploadType: "media"
                  body: ${json.encode({
                    "scene_id": sceneId,
                    "job_name": geniesimGpuJobName,
                    "status": "failed",
                    "timestamp": time.format(sys.now()),
                    "error": {
                      "code": "geniesim_gpu_start_failed",
                      "message": e.message,
                      "type": "workflow_failure",
                      "stack_trace": null
                    },
                    "context": {
                      "workflow_execution_id": sys.get_env("GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID"),
                      "attempt_number": 1,
                      "config_context": {
                        "geniesim_prefix": geniesimPrefix
                      }
                    }
                  })}
            - log_submission_error:
                call: sys.log
                args:
                  text: '${"Failed to execute local Genie Sim job on GKE: " + e.message}'
                  severity: "ERROR"
            - raise_submission_error:
                raise: ${e}
        next: set_gke_submission_execution_name

    - set_gke_submission_execution_name:
        assign:
          - submissionExecutionName: ${geniesimGpuBuild.metadata.build.id}
        next: wait_for_gke_submission_job

    - wait_for_gke_submission_job:
        call: googleapis.cloudbuild.v1.projects.builds.get
        args:
          projectId: ${projectId}
          id: ${submissionExecutionName}
        result: gkeSubmissionStatus
        next: check_gke_submission_status

    - check_gke_submission_status:
        switch:
          - condition: '${gkeSubmissionStatus.status == "FAILURE" or gkeSubmissionStatus.status == "TIMEOUT" or gkeSubmissionStatus.status == "CANCELLED"}'
            next: submission_failed
          - condition: '${gkeSubmissionStatus.status == "SUCCESS"}'
            next: log_submission_complete
        next: wait_gke_submission_poll

    - wait_gke_submission_poll:
        call: sys.sleep
        args:
          seconds: 30
        next: wait_for_gke_submission_job

    - submission_failed:
        assign:
          - submissionEndTime: '${time.format(sys.now())}'
          - submissionDurationSeconds: '${time.parse(submissionEndTime) - time.parse(submissionStartTime)}'
          - submissionTimeoutUsageRatio: '${submissionDurationSeconds / geniesimSubmissionTimeoutSeconds}'
          - submissionTimedOut: '${submissionDurationSeconds >= geniesimSubmissionTimeoutSeconds}'
        next: emit_submission_metrics_failed

    - emit_submission_metrics_failed:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "complete"
            workflow: ${workflowName}
            job: ${submissionJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${geniesimSubmissionTimeoutSeconds}
            duration_seconds: ${submissionDurationSeconds}
            timeout_usage_ratio: ${submissionTimeoutUsageRatio}
            timed_out: ${submissionTimedOut}
            status: "FAILED"
            execution_name: ${default(submissionExecutionName, "unknown")}
            start_time: ${submissionStartTime}
            end_time: ${submissionEndTime}
          severity: "ERROR"
        next: log_submission_failed_message

    - log_submission_failed_message:
        call: sys.log
        args:
          text: '${"ERROR: Genie Sim submission failed for scene " + sceneId}'
          severity: "ERROR"
        next: raise_submission_failed

    - raise_submission_failed:
        raise:
          message: '${"Genie Sim submission failed for scene " + sceneId}'

    - log_submission_complete:
        assign:
          - submissionEndTime: '${time.format(sys.now())}'
          - submissionDurationSeconds: '${time.parse(submissionEndTime) - time.parse(submissionStartTime)}'
          - submissionTimeoutUsageRatio: '${submissionDurationSeconds / geniesimSubmissionTimeoutSeconds}'
          - submissionTimedOut: '${submissionDurationSeconds >= geniesimSubmissionTimeoutSeconds}'
        next: emit_submission_metrics_complete

    - emit_submission_metrics_complete:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "complete"
            workflow: ${workflowName}
            job: ${submissionJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${geniesimSubmissionTimeoutSeconds}
            duration_seconds: ${submissionDurationSeconds}
            timeout_usage_ratio: ${submissionTimeoutUsageRatio}
            timed_out: ${submissionTimedOut}
            status: "SUCCEEDED"
            execution_name: ${submissionExecutionName}
            start_time: ${submissionStartTime}
            end_time: ${submissionEndTime}
          severity: "INFO"
        next: log_submission_complete_message

    - log_submission_complete_message:
        call: sys.log
        args:
          text: '${"Genie Sim submission recorded for scene " + sceneId + " at " + geniesimJobMetadataPath}'
          severity: "INFO"
        next: read_submission_metadata

    - read_submission_metadata:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${geniesimJobMetadataPath}
            alt: "media"
          result: submissionMetadataRaw
        except:
          as: e
          steps:
            - log_submission_metadata_missing:
                call: sys.log
                args:
                  text: '${"Unable to read Genie Sim job metadata for scene " + sceneId + ": " + e.message}'
                  severity: "WARNING"
            - set_missing_submission_metadata_defaults:
                assign:
                  - submittedJobId: "unknown"
                  - submittedJobStatus: "submitted"
                  - submittedEpisodesPrefix: null
                  - submittedFailureReason: "unknown"
                  - submittedFailureDetails: null
            - skip_import_trigger_missing:
                next: write_submitted_marker
        next: parse_submission_metadata

    - parse_submission_metadata:
        assign:
          - submissionMetadata: ${json.decode(submissionMetadataRaw)}
          - submittedJobId: ${submissionMetadata.job_id}
          - submittedJobStatus: ${default(submissionMetadata.status, "submitted")}
          - submittedEpisodesPrefix: ${default(map.get(map.get(submissionMetadata, "artifacts", {}), "episodes_prefix"), null)}
          - submittedFailureReason: ${default(map.get(submissionMetadata, "failure_reason"), "unknown")}
          - submittedFailureDetails: ${default(map.get(submissionMetadata, "failure_details"), null)}
          - submittedJobMetrics: ${default(map.get(submissionMetadata, "job_metrics"), null)}
          - submittedMetricsDuration: ${default(map.get(submittedJobMetrics, "duration_seconds"), null)}
          - submittedMetricsStatus: ${default(map.get(submittedJobMetrics, "status"), null)}
          - submittedMetricsQualityPassRate: ${default(map.get(submittedJobMetrics, "quality_pass_rate"), null)}
        next: evaluate_submission_metrics

    - evaluate_submission_metrics:
        switch:
          - condition: '${submittedJobStatus == "completed" and submittedJobMetrics != null}'
            next: check_submission_sla
          - condition: '${submittedJobStatus == "completed" and submittedJobMetrics == null}'
            next: log_missing_submission_metrics
        next: maybe_trigger_import

    - log_missing_submission_metrics:
        call: sys.log
        args:
          text: '${"Genie Sim job metrics missing for scene " + sceneId + " (job: " + submittedJobId + ")"}'
          severity: "WARNING"
        next: maybe_trigger_import

    - check_submission_sla:
        switch:
          - condition: '${submittedMetricsDuration != null and submittedMetricsDuration > geniesimGenerationSlaSeconds}'
            next: log_submission_sla_violation
        next: maybe_trigger_import

    - log_submission_sla_violation:
        call: sys.log
        args:
          data:
            bp_metric: "geniesim_sla_violation"
            workflow: ${workflowName}
            scene_id: ${sceneId}
            job_id: ${submittedJobId}
            sla_seconds: ${geniesimGenerationSlaSeconds}
            duration_seconds: ${submittedMetricsDuration}
            status: ${submittedMetricsStatus}
            quality_pass_rate: ${submittedMetricsQualityPassRate}
            job_metadata_path: ${geniesimJobMetadataPath}
          severity: "ERROR"
        next: raise_submission_sla_violation

    - raise_submission_sla_violation:
        raise:
          message: '${"Genie Sim job SLA breached for scene " + sceneId + " (job: " + submittedJobId + ")"}'

    - maybe_trigger_import:
        switch:
          - condition: '${submittedJobStatus == "completed"}'
            next: trigger_import_workflow
          - condition: '${submittedJobStatus == "failed"}'
            next: handle_submission_failure
        next: write_submitted_marker

    - trigger_import_workflow:
        call: googleapis.workflowexecutions.v1.projects.locations.workflows.executions.create
        args:
          parent: '${"projects/" + projectId + "/locations/" + region + "/workflows/genie-sim-import-pipeline"}'
          body:
            argument: '${json.encode({"job_id": submittedJobId, "scene_id": sceneId, "status": submittedJobStatus, "local_episodes_prefix": submittedEpisodesPrefix, "job_metadata_path": geniesimJobMetadataPath})}'
        result: importExecution
        next: log_import_trigger

    - log_import_trigger:
        call: sys.log
        args:
          text: '${"Triggered import workflow for completed Genie Sim job " + submittedJobId}'
          severity: "INFO"
        next: wait_for_import_completion

    - wait_for_import_completion:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${geniesimImportCompleteMarker}
          result: importCompletionMarker
        except:
          as: e
          steps:
            - check_import_marker_missing:
                switch:
                  - condition: '${e.code == 404}'
                    next: wait_for_import_marker
                next: raise_import_marker_error
        next: write_completion_marker

    - wait_for_import_marker:
        call: sys.sleep
        args:
          seconds: 10
        next: wait_for_import_completion

    - raise_import_marker_error:
        raise: '${e}'

    - handle_submission_failure:
        call: sys.log
        args:
          text: '${"ERROR: Genie Sim submission failed for scene " + sceneId + " (reason: " + submittedFailureReason + ")"}'
          severity: "ERROR"
        next: write_submission_failure_marker

    - write_submission_failure_marker:
        call: googleapis.storage.v1.objects.insert
        args:
          bucket: ${bucket}
          name: ${geniesimFailedMarker}
          uploadType: "media"
          body: ${json.encode({
            "scene_id": sceneId,
            "job_name": geniesimSubmitJobName,
            "status": "failed",
            "timestamp": time.format(sys.now()),
            "error": {
              "code": "geniesim_submit_failed",
              "message": submittedFailureReason,
              "details": submittedFailureDetails
            },
            "context": {
              "job_id": submittedJobId,
              "job_metadata_path": geniesimJobMetadataPath,
              "workflow_execution_id": sys.get_env("GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID")
            }
          })}
        result: submissionFailureMarkerResult
        next: raise_submission_failed

    - write_submitted_marker:
        call: googleapis.storage.v1.objects.insert
        args:
          bucket: ${bucket}
          name: ${geniesimSubmittedMarker}
          uploadType: "media"
          body: ${json.encode({
            "scene_id": sceneId,
            "status": submittedJobStatus,
            "timestamp": time.format(sys.now()),
            "job_id": submittedJobId,
            "job_metadata_path": geniesimJobMetadataPath
          })}
        result: submittedMarkerResult
        next: done

    # Write completion marker
    - write_completion_marker:
        call: googleapis.storage.v1.objects.insert
        args:
          bucket: ${bucket}
          name: ${geniesimCompleteMarker}
          uploadType: "media"
          body: '${"{\"scene_id\": \"" + sceneId + "\", \"status\": \"completed\", \"timestamp\": \"" + time.format(sys.now()) + "\", \"robot_type\": \"" + robotType + "\", \"commercial_only\": true, \"ready_for_geniesim\": true}"}'
        result: markerResult
        next: done

    - job_failed:
        call: sys.log
        args:
          text: '${"ERROR: Genie Sim export failed for scene " + sceneId}'
          severity: "ERROR"
        next: capture_export_failure_metrics

    - capture_export_failure_metrics:
        assign:
          - exportEndTime: '${time.format(sys.now())}'
          - exportDurationSeconds: '${time.parse(exportEndTime) - time.parse(exportStartTime)}'
          - exportTimeoutUsageRatio: '${exportDurationSeconds / geniesimExportTimeoutSeconds}'
          - exportTimedOut: '${exportDurationSeconds >= geniesimExportTimeoutSeconds}'
        next: emit_export_metrics_failed

    - emit_export_metrics_failed:
        call: sys.log
        args:
          data:
            bp_metric: "job_invocation"
            event: "complete"
            workflow: ${workflowName}
            job: ${geniesimJobName}
            scene_id: ${sceneId}
            timeout_seconds: ${geniesimExportTimeoutSeconds}
            duration_seconds: ${exportDurationSeconds}
            timeout_usage_ratio: ${exportTimeoutUsageRatio}
            timed_out: ${exportTimedOut}
            status: "FAILED"
            execution_name: ${default(executionName, "unknown")}
            start_time: ${exportStartTime}
            end_time: ${exportEndTime}
          severity: "ERROR"
        next: read_failure_marker

    - read_failure_marker:
        try:
          call: googleapis.storage.v1.objects.get
          args:
            bucket: ${bucket}
            object: ${geniesimFailedMarker}
            alt: "media"
          result: geniesimFailurePayload
        except:
          as: e
          steps:
            - handle_missing_geniesim_failure_marker:
                switch:
                  - condition: '${e.code == 404}'
                    next: write_failure_marker
                next: log_geniesim_failure_marker_read_error
        next: log_geniesim_failure_marker_payload

    - log_geniesim_failure_marker_read_error:
        call: sys.log
        args:
          text: '${"Failed to read .failed marker for Genie Sim export in scene " + sceneId + ": " + e.message}'
          severity: "WARNING"
        next: write_failure_marker

    - log_geniesim_failure_marker_payload:
        call: sys.log
        args:
          text: '${"Genie Sim failure marker payload for scene " + sceneId + ": " + geniesimFailurePayload}'
          severity: "ERROR"
        next: write_legacy_failure_marker

    - write_failure_marker:
        call: googleapis.storage.v1.objects.insert
        args:
          bucket: ${bucket}
          name: ${geniesimFailedMarker}
          uploadType: "media"
          body: ${json.encode({
            "scene_id": sceneId,
            "job_name": geniesimJobName,
            "status": "failed",
            "timestamp": time.format(sys.now()),
            "error": {
              "code": "geniesim_export_failed",
              "message": "Genie Sim export failed",
              "type": "workflow_failure",
              "stack_trace": null
            },
            "context": {
              "execution_id": ${default(executionName, "unknown")},
              "workflow_execution_id": sys.get_env("GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID"),
              "attempt_number": 1,
              "config_context": {
                "robot_type": robotType,
                "filter_commercial": filterCommercial,
                "max_tasks": maxTasks
              }
            },
            "input_params": {
              "scene_id": sceneId,
              "bucket": bucket
            }
          })}
        result: failMarkerResult
        next: write_legacy_failure_marker

    - write_legacy_failure_marker:
        call: googleapis.storage.v1.objects.insert
        args:
          bucket: ${bucket}
          name: ${geniesimLegacyFailedMarker}
          uploadType: "media"
          body: '${"{\"scene_id\": \"" + sceneId + "\", \"status\": \"failed\", \"timestamp\": \"" + time.format(sys.now()) + "\"}"}'
        result: legacyFailMarkerResult
        next: done_with_failure

    # =========================================================================
    # Completion
    # =========================================================================

    - done:
        return:
          status: "SUCCESS"
          scene_id: ${sceneId}
          message: '${"Genie Sim export completed for scene " + sceneId}'
          execution: ${geniesimExec.name}
          outputs:
            scene_graph: '${"scenes/" + sceneId + "/geniesim/scene_graph.json"}'
            asset_index: '${"scenes/" + sceneId + "/geniesim/asset_index.json"}'
            task_config: '${"scenes/" + sceneId + "/geniesim/task_config.json"}'
            scene_config: '${"scenes/" + sceneId + "/geniesim/scene_config.yaml"}'
          next_steps:
            - "Arena export will auto-trigger for policy evaluation infrastructure"
            - "Run Genie Sim data collection on your infrastructure"
            - "Episodes will be generated in LeRobot v0.3.3 format"
            - "VLM evaluation included with 100k+ scenarios"
            - "Use Arena benchmarks to evaluate trained policies"

    - done_with_failure:
        return:
          status: "FAILED"
          scene_id: ${sceneId}
          message: '${"Genie Sim export failed for scene " + sceneId}'

    - skip:
        return:
          status: "SKIPPED"
          message: '${"Not a replicator completion marker file or Genie Sim disabled: " + object}'
